{"config":{"lang":["en"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"]},"docs":[{"location":"","title":"Home","text":""},{"location":"#abstract","title":"Abstract","text":""},{"location":"#background","title":"Background","text":"<p>Starting with 2021, we received some feedback as follows.</p> <p>There are two clusters A and B. Cluster A is VMware-based and runs mainly Database workloads, and Cluster B is a Kubernetes cluster. Some applications in Cluster B need to access the database in Cluster A, and the network administrator wants the cluster Pods to be managed through an egress gateway.</p>"},{"location":"#features","title":"Features","text":"<p>The gateway provides network egress capabilities for Kubernetes clusters.</p> <ul> <li>Solve IPv4 IPv6 dual-stack connectivity.</li> <li>Solve the high availability of Egress Nodes.</li> <li>Allow filtering Pods Egress Policy (Destination CIDR).</li> <li>Allow filtering of egress Applications (Pods).</li> <li>Can be used in low kernel version.</li> </ul>"},{"location":"#crds","title":"CRDs","text":"<p>The egress gateway model abstracts three Custom Resource Definitions (CRDs): <code>EgressNode</code> , <code>EgressNode</code> and <code>EgressGatewayPolicy</code>. They are cluster scoped CRDs.</p>"},{"location":"#egressgateway","title":"EgressGateway","text":"<pre><code>apiVersion: egressgateway.spidernet.io/v1\nkind: EgressGateway\nmetadata:\n  name: \"egressgateway\"\nspec:\n  nodeSelector:\n    matchLabels:\n      egress: \"true\"\nstatus:\n  nodeList:\n    - name: \"node1\"\n      ready: true\n      active: true\n</code></pre> <ul> <li>spec<ul> <li><code>nodeSelector</code> field matching against node labels.</li> </ul> </li> <li>status<ul> <li><code>nodeList</code> field is the list of nodes matched by <code>nodeSelector</code><ul> <li><code>ready</code> field represents the node status, which may be <code>Ready</code>, <code>NotReady</code> or <code>Unknown</code>.<ul> <li>Only nodes in the <code>Ready</code> state can participate in the election of egress gateway nodes.</li> </ul> </li> <li><code>avtive</code> field represents that the non-egress gateway is reconcile or reconcile completes accessing the destination CIDR(e.g. Cluster A CIDR in picture 1) with this node.</li> <li><code>interfaces</code> is physical network interface list. It is updated by the Agent.<ul> <li><code>ipv4</code> address list.</li> <li><code>ipv6</code> address list.</li> </ul> </li> </ul> </li> </ul> </li> </ul>"},{"location":"#egressnode","title":"EgressNode","text":"<pre><code>apiVersion: egressgateway.spidernet.io/v1\nkind: EgressNode\nmetadata:\n  name: \"node1\"\nspec: {}\nstatus:\n  phase: \"Succeeded\"\n  vxlanIPv4: \"172.31.0.10/16\"\n  vxlanIPv6: \"fe80::/64\"\n  tunnelMac: \"xx:xx:xx:xx:xx\"\n  physicalInterface: \"eth1\"\n  physicalInterfaceIPv4: \"\"\n  physicalInterfaceIPv6: \"\"\n</code></pre> <p>The <code>EgressNode</code> CRD stores vxlan tunnel information, which is generated by the Controller from the Node CR.</p> <ul> <li>status<ul> <li><code>phase</code> indicates the status of EgressNode. If 'Succeeded' has been assigned and the tunnel has been built, 'Pending' is waiting for IP assignment, 'Init' succeeds in assigning the tunnel IP address, and 'Failed' fails to assign the tunnel IP address.</li> <li><code>vxlanIPv4</code> field represents the IPv4 address of VXLAN tunnel.</li> <li><code>vxlanIPv6</code> field represents the IPv6 address of VXLAN tunnel.</li> <li><code>tunnelMac</code> field represents the MAC address of IPv4 VXLAN tunnel Interface.</li> <li><code>physicalInterface</code> is parent name of VXLAN tunnel interface.</li> <li><code>physicalInterfaceIPv4</code> is parent IPv4 Address of VXLAN tunnel interface.</li> <li><code>physicalInterfaceIPv6</code> is parent IPv6 Address of VXLAN tunnel interface.</li> </ul> </li> </ul>"},{"location":"#egressgatewaypolicy","title":"EgressGatewayPolicy","text":"<pre><code>apiVersion: egressgateway.spidernet.io/v1\nkind: EgressGatewayPolicy\nmetadata:\n  name: \"policy\"\nspec:\n  appliedTo:\n    podSelector:\n      matchLabels:\n        app: \"shopping\"\n  destSubnet:\n    - \"10.6.1.0/24\"\n</code></pre> <ul> <li>spec<ul> <li><code>podSelector</code> filed selects the grouping of pods to which the policy applies.</li> <li><code>podSubnet</code> field specifies the pod CIDR affected by the egress policy. It conflicts with the <code>podSelector</code> field.</li> <li><code>destSubnet</code> destination CIDR block list.</li> </ul> </li> </ul>"},{"location":"#datapath","title":"Datapath","text":"<p>A combination of vxlan tunnel, ipset, iptables, route is required to complete policy control.</p>"},{"location":"#non-egress-node","title":"Non Egress Node","text":""},{"location":"#vxlan","title":"VXLAN","text":"<p>Build a VXLAN tunnel on cluster nodes. There are 2 tunnel NICs named <code>egress-vxlan-v4</code> and <code>egress-vxlan-v6</code>.</p>"},{"location":"#ipset","title":"IPSet","text":"<pre><code>sudo ipset create egress-dst-policy-name\nsudo ipset add egress-dest-policy-name 172.16.1.1/32\n</code></pre>"},{"location":"#iptables","title":"IPTables","text":"<pre><code>iptables -t mangle -F EGRESSGATEWAY-MARK-REQUEST-POLICY-NAME\niptables -t mangle -X EGRESSGATEWAY-MARK-REQUEST-POLICY-NAME\niptables -t mangle -N EGRESSGATEWAY-MARK-REQUEST-POLICY-NAME\n\niptables -A EGRESSGATEWAY-MARK-REQUEST-POLICY-NAME \\\n  -t mangle \\\n  -m conntrack --ctdir ORIGINAL \\\n  -m set --match-set egress-dst-policy-name dst \\\n  -m set --match-set egress-src-policy-name src \\\n  -j MARK --set-mark 0x11000000 \\\n  -m comment --comment \"rule uuid: mark request packet\"\n</code></pre>"},{"location":"#route","title":"Route","text":"<p>Normal.</p> <pre><code>ip rule add fwmark 0x11000000 table 100\nip route f table 100\nip route add default via 20.0.0.85 dev egress-vxlan-v4 onlink table 100\n</code></pre> <p>Equal-cost multi-path routing.</p> <pre><code>sysctl -w net.ipv4.fib_multipath_hash_policy=1\n</code></pre> <pre><code>ip rule add fwmark 0x11000000 table 100\nip route f table 100\nip route add table 100 default \\\n  nexthop via 20.0.0.85 dev egress-vxlan onlink \\\n  nexthop via 20.0.0.90 dev egress-vxlan onlink\n</code></pre>"},{"location":"#egress-node","title":"Egress Node","text":"<pre><code>iptables -t mangle -I FORWARD 1 -m mark --mark 0x11000000 -j MARK --set-mark 0x12000000 -m comment --comment \"egress gateway: change mark\"\niptables -t filter -I FORWARD 1 -m mark --mark 0x12000000 -j ACCEPT -m comment --comment \"egress gateway: keep mark\"\niptables -t filter -I OUTPUT 1 -m mark --mark 0x12000000 -j ACCEPT -m comment --comment \"egress gateway: keep mark\"\niptables -t mangle -I POSTROUTING 1 -m mark --mark 0x12000000 -j ACCEPT -m comment --comment \"egress gateway: keep mark\"\niptables -t nat -I POSTROUTING 1 -m mark --mark 0x12000000 -j ACCEPT -m comment --comment \"egress gateway: no snat\"\n</code></pre>"},{"location":"#cni-compatibility","title":"CNI Compatibility","text":""},{"location":"#calico","title":"Calico","text":"<p>Required settings <code>chainInsertMode</code> to <code>Append</code>, for example in the code, more reference calico docs:</p> <pre><code>apiVersion: projectcalico.org/v3\nkind: FelixConfiguration\nmetadata:\n  name: default\nspec:\n  ipv6Support: false\n  ipipMTU: 1400\n  chainInsertMode: Append\n</code></pre>"},{"location":"#implementation","title":"Implementation","text":""},{"location":"#controller","title":"Controller","text":"<p>Controller consists of Webhook Validator and Reconcile Flow.</p> <p></p> <p>Controller has 2 control processes, the first Watch cluster nodes, generate tunnel IP address and MAC address for Node, then <code>Create</code> or <code>Update</code> EgressNode CR Status. The second control flow watch <code>EgressNode</code> and <code>Egressgateway</code>, sync match node list from <code>labelSelector</code>, election egress gateway node.</p>"},{"location":"#agent","title":"Agent","text":"<p>Agent has two control processes, the first Watch <code>EgressNode</code> CR, which manages node tunnel, and node tunnel is a pluggable interface that can be replaced by Geneve. The second control process manages datapath policy, which watches <code>EgressNode</code>, <code>EgressGateway</code> and <code>Egresspolicy</code>, and sends them to the host through the police interface. It is currently implemented by a combination of ipset, iptables, and route, and it can be replaced by eBPF.</p>"},{"location":"develop/contribute/","title":"How To Contribute","text":"<p>First of all, thank you for your interest in contributing to our project! We appreciate all the help and support from the community. This document outlines the process for contributing to our Kubernetes operator project. Please read through the guidelines carefully before submitting any changes.</p>"},{"location":"develop/contribute/#code-of-conduct","title":"Code of Conduct","text":"<p>To ensure a positive and supportive environment for all contributors, please adhere to our Code of Conduct. By participating in this project, you agree to abide by its terms.</p>"},{"location":"develop/contribute/#getting-started","title":"Getting Started","text":"<p>Fork the Repository: To contribute, start by forking the repository to your own GitHub account. This will create a copy of the project that you can modify as needed.</p> <p>Clone the Fork: After forking the repository, clone your fork to your local machine using Git. This will allow you to work on the project locally.</p> <pre><code>git clone https://github.com/your-username/your-project-name.git\n</code></pre> <p>Create a Branch: Before starting to work on your changes, create a new branch for each feature or bugfix. This helps to keep your changes separated and organized. Use a descriptive name for your branch.</p> <pre><code>git checkout -b your-new-branch-name\n</code></pre>"},{"location":"develop/contribute/#making-changes","title":"Making Changes","text":"<p>Update Your Fork: Before making any changes, make sure your fork is up to date with the upstream repository.</p> <pre><code>git remote add upstream https://github.com/original-owner/your-project-name.git\ngit fetch upstream\ngit merge upstream/main\n</code></pre> <p>Test Your Changes: After making changes, ensure that they do not break the project by running tests. Be sure to test your changes in a Kubernetes environment if possible.</p> <p>Commit Your Changes: When you're satisfied with your changes, commit them using a clear and concise commit message. This helps the maintainers understand the purpose of your changes.</p> <pre><code>git add .\ngit commit -m \"Your commit message\"\n</code></pre> <p>Push Your Changes: After committing your changes, push them to your fork on GitHub.</p> <pre><code>git push origin your-new-branch-name\n</code></pre>"},{"location":"develop/contribute/#submitting-a-pull-request","title":"Submitting a Pull Request","text":"<p>Create a Pull Request: Once your changes are pushed, create a pull request from your fork to the upstream repository. Make sure the base branch is set to main and the head branch is your feature or bugfix branch.</p> <p>Describe Your Changes: In the pull request description, provide a clear and concise description of the changes you made. Include any relevant issue numbers and explain how your changes address the issue or add a new feature.</p> <p>Wait for a Review: After submitting your pull request, wait for a project maintainer to review your changes. They may request changes or provide feedback on your work. Be sure to address any feedback and update your pull request as needed.</p> <p>Merge: Once your changes have been reviewed and approved, a project maintainer will merge your pull request. Congratulations, you've successfully contributed to the project!</p>"},{"location":"develop/dev/","title":"Develop","text":""},{"location":"develop/dev/#quick-start","title":"Quick Start","text":"<ol> <li> <p><code>make build_local_image</code></p> </li> <li> <p><code>make e2e_init</code></p> </li> <li> <p><code>make e2e_run</code></p> </li> <li> <p>check proscope, browser visits http://nodeIP:4040</p> </li> </ol>"},{"location":"develop/dev/#go-package-structure-design","title":"Go Package (Structure) Design","text":"<pre><code>.\n\u251c\u2500\u2500 api\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 v1\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 client\n\u2502\u00a0\u00a0     \u2502\u00a0\u00a0 \u251c\u2500\u2500 healthy\n\u2502\u00a0\u00a0     \u2502\u00a0\u00a0 \u2514\u2500\u2500 http_server_api_client.go\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 openapi.yaml\n\u2502\u00a0\u00a0     \u2514\u2500\u2500 server\n\u2502\u00a0\u00a0         \u251c\u2500\u2500 configure_http_server_api.go\n\u2502\u00a0\u00a0         \u251c\u2500\u2500 doc.go\n\u2502\u00a0\u00a0         \u251c\u2500\u2500 embedded_spec.go\n\u2502\u00a0\u00a0         \u251c\u2500\u2500 restapi\n\u2502\u00a0\u00a0         \u2514\u2500\u2500 server.go\n\u251c\u2500\u2500 charts\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 Chart.yaml\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 crds\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 egressgateway.spidernet.io_egressgatewaypolicies.yaml\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 egressgateway.spidernet.io_egressgateways.yaml\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 egressgateway.spidernet.io_egressnodes.yaml\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 LICENSE\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 README.md\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 templates\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 configmap.yaml\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 daemonset.yaml\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 deployment.yaml\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 grafanaDashboard.yaml\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 _helpers.tpl\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 pdb.yaml\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 prometheusrule.yaml\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 roleBinding.yaml\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 role.yaml\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 serviceaccount.yaml\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 servicemonitor.yaml\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 service.yaml\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 tls.yaml\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 values.yaml\n\u251c\u2500\u2500 cmd\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 agent\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 cmd\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 root.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 main.go\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 controller\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 cmd\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 root.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 main.go\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 nettools\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 client\n\u2502\u00a0\u00a0     \u2502\u00a0\u00a0 \u2514\u2500\u2500 main.go\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 initFlag.go\n\u2502\u00a0\u00a0     \u2514\u2500\u2500 server\n\u2502\u00a0\u00a0         \u2514\u2500\u2500 main.go\n\u251c\u2500\u2500 codecov.yml\n\u251c\u2500\u2500 CODEOWNERS\n\u251c\u2500\u2500 docs\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 develop\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 dev.md\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 mkdocs.yml\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 proposal\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 01-egress-gateway\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 Agent\\ Reconcile\\ Flow.png\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 Controller\\ Reconcile\\ Flow.png\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 Egress\\ Gateway\\ Datapath.png\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 Egress\\ Gateway.png\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 02-egress-node\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0     \u2514\u2500\u2500 EgressNode-zh_CN.md\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 README.md\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 usage\n\u2502\u00a0\u00a0     \u2514\u2500\u2500 Install.md\n\u251c\u2500\u2500 go.mod\n\u251c\u2500\u2500 go.sum\n\u251c\u2500\u2500 images\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 agent\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 Dockerfile\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 agent-base\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 build-gops.sh\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 configure-iptables-wrapper.sh\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 Dockerfile\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 install-others.sh\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 iptables-wrapper\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 sources.list\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 controller\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 Dockerfile\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 controller-base\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 build-gops.sh\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 Dockerfile\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 install-others.sh\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 sources.list\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 nettools\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 Dockerfile\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 nettools-base\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 build-gops.sh\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 configure-iptables-wrapper.sh\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 Dockerfile\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 install-others.sh\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 iptables-wrapper\n\u2502\u00a0\u00a0     \u2514\u2500\u2500 sources.list\n\u251c\u2500\u2500 LICENSE\n\u251c\u2500\u2500 Makefile\n\u251c\u2500\u2500 Makefile.defs\n\u251c\u2500\u2500 pkg\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 agent\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 agent.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 metrics\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 metrics.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 police.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 police_test.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 route\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 route.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 vxlan\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 parent.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 parent_test.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 vxlan.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 vxlan_test.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 vxlan.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 vxlan_test.go\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 config\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 config.go\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 controller\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 allocator\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 allocator.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 interface.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 controller.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 controller_test.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 egress_gateway.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 egress_gateway_test.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 egress_node.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 metrics\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 metrics.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 node.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 webhook\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0     \u251c\u2500\u2500 validate.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0     \u2514\u2500\u2500 validate_test.go\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 ethtool\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 ethtool_darwin.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 ethtool_linux.go\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 ipam\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 ipam.go\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 ipset\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 ipset.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 testing\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 ipset.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 types.go\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 iptables\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 actions.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 binary.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 cmdshim\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 cmd_shim.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 interface.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 lock.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 match_builder.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 metrics.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 restore_buffer.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 rules.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 table.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 testutils\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 test.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 version.go\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 k8s\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 apis\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 egressgateway.spidernet.io\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 client\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0     \u251c\u2500\u2500 clientset\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0     \u251c\u2500\u2500 informers\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0     \u2514\u2500\u2500 listers\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 lock\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 lock_debug.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 lock_debug_test.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 lock_fast.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 lock_fast_test.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 lock.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 lock_suite_test.go\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 logger\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 logger.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 logsink.go\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 profiling\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 manager.go\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 schema\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 schema.go\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 types\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 interface.go\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 utils\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 flat.go\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 map.go\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 node.go\n\u2502\u00a0\u00a0     \u2514\u2500\u2500 set\n\u2502\u00a0\u00a0         \u251c\u2500\u2500 interface.go\n\u2502\u00a0\u00a0         \u2514\u2500\u2500 set.go\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 test\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 doc\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 egressgateway.md\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 egressnode.md\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 egresspolicy.md\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 stress.md\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 e2e\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 common\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 constant.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 deployment.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 egressconfigmap.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 egressgateway.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 egressnode.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 egresspolicy.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 err.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 ip.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 iptables.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 node.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 egressgateway\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 egressgateway_suite_test.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 egressgateway_test.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 egressnode\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 egressnode_suite_test.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 egressnode_test.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 egresspolicy\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 egresspolicy_suite_test.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 egresspolicy_test.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 err\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 err.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 example\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 example_suite_test.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 example_test.go\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 tools\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0     \u2514\u2500\u2500 tools.go\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 kindconfig\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 global-kind.yaml\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 Makefile\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 scripts\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 check-nettools-server.sh\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 debugCluster.sh\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 getPerformanceData.sh\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 installCalico.sh\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 installE2eTools.sh\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 test.go\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 yaml\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 calico.yaml\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 grafanadashboards.yaml\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 monitoring.coreos.com_podmonitors.yaml\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 monitoring.coreos.com_probes.yaml\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 monitoring.coreos.com_prometheusrules.yaml\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 monitoring.coreos.com_servicemonitors.yaml\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 testclient.yaml\n\u2502\u00a0\u00a0     \u251c\u2500\u2500 testpod.yaml\n\u2502\u00a0\u00a0     \u2514\u2500\u2500 testserver.yaml\n\u251c\u2500\u2500 tools\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 copyright-header.txt\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 golang\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 codeCoverage.sh\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 crdControllerGen.sh\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 crdSdkGen.sh\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 e2ecover.sh\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 ginkgo.sh\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 goSwagger.sh\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 images\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 get-image-digest.sh\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 update-golang-image.sh\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 scripts\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 changelog.sh\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 tools.go\n\u251c\u2500\u2500 VERSION\n\u2514\u2500\u2500 vendor\n</code></pre>"},{"location":"develop/release/","title":"workflow for release","text":""},{"location":"develop/release/#pre-steps","title":"pre-steps","text":"<ul> <li> <p>update 'version' and 'appVersion' filed in 'charts/*/Chart.yaml'</p> </li> <li> <p>update version in '/VERSION'</p> </li> <li> <p>a version tag should be set on right branch. The version should go with </p> <ul> <li> <p>v0.1.0-rc0</p> </li> <li> <p>v0.1.0-rc1</p> </li> <li> <p>v0.1.0</p> </li> <li> <p>v0.1.1</p> </li> <li> <p>v0.1.2</p> </li> <li> <p>v0.2.0-rc0</p> </li> <li> <p>v0.2.0</p> </li> </ul> </li> </ul>"},{"location":"develop/release/#push-a-version-tag","title":"push a version tag","text":"<p>If a tag vx.x.x is pushed , the following steps will automatically run:</p> <ol> <li> <p>check the tag name is same with '/VERSION'</p> </li> <li> <p>create a branch named 'release-vx.x.x'</p> </li> <li> <p>build the images with the pushed tag, and push to ghcr registry</p> </li> <li> <p>generate the changelog by historical PR labeled as \"pr/release/*\"</p> <p>submit the changelog file to directory 'changelogs' of branch 'github_pages', with PR labeled as \"pr/release/robot_update_githubpage\".</p> <p>changelogs are generated by historical PR label:</p> <p>label \"pr/release/feature-new\" to be classified to \"New Features\"</p> <p>label \"pr/release/feature-changed\" to be classified to \"Changed Features\"</p> <p>label \"pr/release/feature-bug\" to be classified to \"Fixes\"</p> </li> <li> <p>build the chart package with the pushed tag, and submit a PR to branch 'github_pages' </p> <p>you cloud get the chart with command <code>helm repo add $REPO_NAME https://spidernet-io.github.io/$REPO_NAME</code></p> </li> <li> <p>submit '/docs' to '/docs' of branch 'github_pages'</p> </li> <li> <p>create a GitHub Release attached with the chart package and changelog</p> </li> <li> <p>Finally, by hand, need approve the chart PR labeled as \"pr/release/robot_update_githubpage\" , and changelog PR labeled as \"pr/release/robot_update_githubpage\"</p> </li> </ol>"},{"location":"develop/release/#post","title":"post","text":"<ol> <li>Submit an issue of the version update to the documentation site --&gt; https://github.com/DaoCloud/DaoCloud-docs</li> </ol>"},{"location":"develop/roadmap/","title":"roadmap","text":"kind feature schedule status gateway support multiple instances of gateway class doing support for namespace doing support default gateway class doing all data stream could loadbalance to all gateway node doing when a gateway node breakdown , all data stream could to to healthy gateway node doing could specify the node interface for tunnel, by hand, or auto select a reasonable one doing tunnel protocol vxlan doing geneve encryption ipsec wireGuard destination CIDR could auto distinguish internal CIDR (calico\u3001flannel etc, or by hand) and outside CIDR doing could specify the outside CIDR by hands doing data protocl tcp doing udp doing websocket sctp multicast policy support priority doing support cluster scope policy doing support namespace scope policy doing support cni calico doing flannel doing weave doing macvlan+spiderpool doing ip stack ipv4-only doing ipv6-only doing dual stack doing source IP support EIP for application doing support EIP for namespace doing use node ip doing datapath iptables with low and high version doing ebpf performance big cluster, with lots of gateway nodes big cluster, with lots of  nodes big cluster, with lots of  pods when gateway node down, the whole cluster could change to healthy gateway node within 2s after apply or modify lots of policy, it could quick take effect in a big cluster after apply or modify gatewaynode, it could quick take effect in a big cluster forward throughput of each gateway node CPU and memory usage under pressure HA all component pods could recovery quickly and serve after breakdown all pods could run for one week without failure insight metrics log doc design, usage, debug docs architecture amd and arm"},{"location":"develop/datapath/README_zh-CN/","title":"README zh CN","text":"<p>\u5bf9\u9700\u8981\u751f\u6548\u7684\u89c4\u5219\u5206\u4e3a\u4e09\u7c7b\uff1a\u6240\u6709\u8282\u70b9\uff0c\u76f8\u5bf9\u4e8e EgressGatewayPolicy \u7684\u300c\u7f51\u5173\u8282\u70b9\u300d\u548c\u300c\u975e\u7f51\u5173\u8282\u70b9\u300d\u3002\u53ea\u6709\u5f53\u4e1a\u52a1 Pod \u8c03\u5ea6\u5230\u7684\u300c\u975e\u7f51\u5173\u8282\u70b9\u300d\uff0c\u8be5\u8282\u70b9\u4e0a\u7684\u89c4\u5219\u624d\u4f1a\u751f\u6548\u3002</p>"},{"location":"develop/datapath/README_zh-CN/#_1","title":"\u6240\u6709\u8282\u70b9","text":"<ol> <li>\u5404\u8282\u70b9\u4e4b\u95f4\uff0c\u96a7\u9053\u9700\u8981\u6253\u901a\u7684\u89c4\u5219\u5c31\u5c31\u4e0d\u4e00\u4e00\u5c55\u5f00\uff1b</li> <li>\u5c06 policy \u547d\u4e2d\u7684\u6d41\u91cf\uff0c\u91cd\u65b0\u6253\u6807\u7b7e\u3002\u8282\u70b9\u7b2c\u4e00\u6b21\u53d8\u6210\u7f51\u5173\u8282\u70b9\u65f6\u66f4\u65b0\uff0c\u6216\u8005\u8282\u70b9 join \u65f6\u505a\u4e00\u6b21\uff0c\u540e\u9762\u4e0d\u66f4\u65b0\uff1b    ```shell    iptables -t mangle -N EGRESSGATEWAY-RESET-MARK    iptables -t mangle -I FORWARD 1  -j EGRESSGATEWAY-RESET-MARK -m comment --comment \"egress gateway: mark egress packet\"</li> </ol> <p>iptables -t mangle -A EGRESSGATEWAY-RESET-MARK \\        -m mark --mark $NODE_MARK/0x26000000 \\        -j MARK --set-mark 0x12000000 \\        -m comment --comment \"egress gateway: change mark\"    ```</p> <ol> <li>\u4fdd\u6301 policy \u547d\u4e2d\u6d41\u91cf\u7684\u6807\u7b7e\u3002\u76f4\u63a5\u521b\u5efa\u4e00\u6b21\uff0c\u4e0d\u9700\u8981\u66f4\u65b0\uff1b    ```shell    iptables -t filter -I FORWARD 1 -m mark --mark 0x12000000 -j ACCEPT -m comment --comment \"egress gateway: keep mark\"</li> </ol> <p>iptables -t filter -I OUTPUT 1 -m mark --mark 0x12000000 -j ACCEPT -m comment --comment \"egress gateway: keep mark\"</p> <p>iptables -t mangle -I POSTROUTING 1 -m mark --mark 0x12000000 -j ACCEPT -m comment --comment \"egress gateway: keep mark\"    ```</p> <ol> <li>\u805a\u5408 policy \u547d\u4e2d\u6d41\u91cf\u6253\u6807\u7b7e\u7684\u94fe\u3002\u76f4\u63a5\u521b\u5efa\u4e00\u6b21\uff0c\u4e0d\u9700\u8981\u66f4\u65b0\uff1b    ```shell    iptables -t mangle -N EGRESSGATEWAY-MARK-REQUEST</li> </ol> <p>iptables -t mangle -I PREROUTING 1 -j EGRESSGATEWAY-MARK-REQUEST -m comment --comment \"egress gateway: mark egress packet\"    ```</p> <ol> <li>\u805a\u5408\u4e0d\u9700\u8981\u505a SNAT \u89c4\u5219\u7684\u94fe\u3002\u76f4\u63a5\u521b\u5efa\u4e00\u6b21\uff0c\u4e0d\u9700\u8981\u66f4\u65b0\uff1b    ```shell    iptables -t nat -N EGRESSGATEWAY-NO-SNAT</li> </ol> <p>iptables -t nat -I POSTROUTING 1  -j EGRESSGATEWAY-NO-SNAT -m comment --comment \"egress gateway: no snat\"</p> <p>iptables -t nat -A EGRESSGATEWAY-NO-SNAT -m mark --mark 0x12000000 -j ACCEPT -m comment --comment \"egress gateway: no snat\"    ```</p> <ol> <li>\u805a\u5408\u9700\u8981\u505a SNAT \u89c4\u5219\u7684\u94fe\u3002\u76f4\u63a5\u521b\u5efa\u4e00\u6b21\uff0c\u4e0d\u9700\u8981\u66f4\u65b0\u3002    ```shell    iptables -t nat -N EGRESSGATEWAY-SNAT-EIP</li> </ol> <p># \u9700\u8981\u5728\u4e0d\u9700\u8981 SNAT \u7684\u89c4\u5219\u540e\u9762\u63d2\u5165\uff0c\u624d\u80fd\u4fdd\u8bc1\u8be5\u94fe\u5728\u6700\u524d\u9762    iptables -t nat -I POSTROUTING 1  -j EGRESSGATEWAY-SNAT-EIP -m comment --comment \"egress gateway: snat EIP\"    ```</p> <ol> <li>egress-ingore-cidr \u5f53 EgressGatewayPolicy \u7684 <code>destSubnet</code> \u5b57\u6bb5\u4e3a\u7a7a\u65f6\uff0c\u6570\u636e\u9762\u5c06\u4f1a\u81ea\u52a8\u5339\u914d EgressClusterStatus CR \u4e2d\u7684 CIDR \u4e4b\u5916\u7684\u6d41\u91cf\uff0c\u5e76\u5c06\u5176\u8f6c\u53d1\u5230 Egress \u7f51\u5173\u3002     ```shell    IPSET_RULE_DEST_NAME=egress-ingore-cidr</li> </ol> <p>ipset x $IPSET_RULE_DEST_NAME</p> <p>ipset create $IPSET_RULE_DEST_NAME hash:net</p> <p>ipset add $IPSET_RULE_DEST_NAME 10.6.105.150/32    ```</p>"},{"location":"develop/datapath/README_zh-CN/#eip-egress-gateway","title":"\u76f8\u5bf9\u4e8e EIP \u7684\u975e Egress Gateway \u8282\u70b9","text":"<ol> <li>policy \u547d\u4e2d\u7684\u6e90 IP\u3001\u76ee\u7684 IP \u7684 ipset\uff1b    ```shell    IPSET_RULE_DEST_NAME=egress-dest-uuid</li> </ol> <p>ipset x $IPSET_RULE_DEST_NAME</p> <p>ipset create $IPSET_RULE_DEST_NAME hash:net</p> <p>ipset add $IPSET_RULE_DEST_NAME 10.6.105.150/32</p> <p>IPSET_RULE_SRC_NAME=egress-src-uuid</p> <p>ipset x $IPSET_RULE_SRC_NAME</p> <p>ipset create $IPSET_RULE_SRC_NAME hash:net</p> <p>ipset add $IPSET_RULE_SRC_NAME 172.29.234.173/32    ```</p> <ol> <li> <p>policy \u547d\u4e2d\u7684\u6d41\u91cf\u6253\u6807\u7b7e\uff0c\u4fdd\u8bc1\u80fd\u4ece\u96a7\u9053\u8d70\u3002\u5176\u4e2d NODE_MARK \u7684\u503c\u6839\u636e policy \u5bf9\u5e94\u7684 EIP \u6240\u5728\u8282\u70b9\u51b3\u5b9a\u3002    <code>shell    iptables -A EGRESSGATEWAY-MARK-REQUEST -t mangle -m conntrack --ctdir ORIGINAL \\    -m set --match-set $IPSET_RULE_DEST_NAME dst  \\    -m set --match-set $IPSET_RULE_SRC_NAME src  \\    -j MARK --set-mark $NODE_MARK -m comment --comment \"rule uuid: mark request packet\"</code></p> </li> <li> <p>\u7b56\u7565\u8def\u7531\u89c4\u5219    <code>shell    ip rule add fwmark $NODE_MARK table $TABLE_NUM</code></p> </li> <li> <p>\u9002\u914d Weave \u907f\u514d\u505a SNAT \u6210 Egress \u96a7\u9053\u7684 IP\u3002\u505a\u6210\u5f00\u5173    <code>shell    iptables -t nat -A EGRESSGATEWAY-NO-SNAT \\    -m set --match-set $IPSET_RULE_DEST_NAME dst  \\    -m set --match-set $IPSET_RULE_SRC_NAME src  \\    -j ACCEPT -m comment --comment \"egress gateway: weave does not do SNAT\"</code></p> </li> </ol>"},{"location":"develop/datapath/README_zh-CN/#eip-egress-gateway_1","title":"\u76f8\u5bf9\u4e8e EIP \u7684 Egress Gateway \u8282\u70b9","text":"<ol> <li>policy \u547d\u4e2d\u7684\u6e90 IP\u3001\u76ee\u7684 IP \u7684 ipset\uff1b    ```shell    IPSET_RULE_DEST_NAME=egress-dest-uuid</li> </ol> <p>ipset x $IPSET_RULE_DEST_NAME</p> <p>ipset create $IPSET_RULE_DEST_NAME hash:net</p> <p>ipset add $IPSET_RULE_DEST_NAME 10.6.105.150/32</p> <p>IPSET_RULE_SRC_NAME=egress-src-uuid</p> <p>ipset x $IPSET_RULE_SRC_NAME</p> <p>ipset create $IPSET_RULE_SRC_NAME hash:net</p> <p>ipset add $IPSET_RULE_SRC_NAME 172.29.234.173/32    ```</p> <ol> <li>policy \u547d\u4e2d\u7684\u6d41\u91cf\u3002\u51fa\u7f51\u5173\u65f6\u505a SNAT\u3002\u5b9e\u65f6\u66f4\u65b0\u3002    <code>shell    iptables -t nat -A EGRESSGATEWAY-SNAT-EIP \\        -m set --match-set $IPSET_RULE_SRC_NAME src \\        -m set --match-set $IPSET_RULE_DST_NAME dst \\        -j SNAT --to-source $EIP</code></li> </ol>"},{"location":"develop/datapath/README_zh-CN/#_2","title":"\u5176\u4ed6","text":"<ol> <li>NODE_MARK\uff1a\u6bcf\u4e2a\u8282\u70b9\u5bf9\u5e94\u4e00\u4e2a\uff0c\u5168\u5c40\u552f\u4e00\u7684\u6807\u7b7e\u3002\u6807\u7b7e\u7531\u524d\u7f00 + \u552f\u4e00\u6807\u8bc6\u7b26\u751f\u6210\u3002\u6807\u7b7e\u683c\u5f0f\u5982\u4e0b <code>NODE_MARK = 0x26 + value + 0000</code>\uff0c<code>value</code> \u4e3a 16 \u4f4d\uff0c\u652f\u6301\u7684\u8282\u70b9\u603b\u6570\u4e3a <code>2^16</code>\u3002</li> <li>TABLE_NUM\uff1a</li> <li>\u7531\u4e8e\u6bcf\u4e2a\u4e3b\u673a\u53ea\u80fd [0, 255] \u5f20\u8def\u7531\u8868\uff08\u5176\u4e2d 0\u3001253\u3001254\u3001255 \u5df2\u88ab\u7cfb\u7edf\u4f7f\u7528\uff09\uff0c\u8d85\u51fa\u8868\u7684\u5f20\u6570\u65f6\uff0c\u4f1a\u5bfc\u81f4\u8282\u70b9\u8def\u7531\u6ca1\u6cd5\u8ba1\u7b97\uff0c\u4ece\u800c\u8282\u70b9\u5931\u8054\u3002\u800c\u4e14\u8868\u540d\u4e0e\u8868\u7684 ID \u5339\u914d\uff0c\u5982\u679c\u6ca1\u6709\u5339\u914d\uff0c\u5219\u5185\u6838\u4f1a\u968f\u673a\u5206\u914d\u3002\u6240\u4ee5\u4e3a\u4e86\u4fdd\u9669\u8d77\u89c1\uff0c\u63a7\u5236\u8868\u7684\u7684\u5f20\u6570\uff08n \u8868\u793a\uff0c\u9ed8\u8ba4\u503c\u4e3a 100\uff09\u4e5f\u5c31\u662f\u7f51\u5173\u8282\u70b9\u7684\u4e0a\u9650\uff0c\u53ef\u4ee5\u901a\u8fc7\u53d8\u91cf\u8bbe\u7f6e\u3002</li> <li>TABLE_NUM \u7b97\u6cd5\uff1a\u7528\u6237\u53ef\u4ee5\u8bbe\u7f6e\u4e00\u4e2a\u8d77\u59cb\u503c\uff08s \u8868\u793a\uff0c\u9ed8\u8ba4\u503c\u4e3a 3000\uff09\uff0c\u5219\u8868\u540d\u7684\u8303\u56f4\u4e3a [s, (s+n)]\uff0c\u7528\u6237\u9700\u8981\u4fdd\u8bc1 [s, (s+n)] \u7684\u8868\u540d\u6ca1\u6709\u88ab\u5360\u7528\u3002\u968f\u673a\u4ece [s, (s+n)] \u53d6\u4e00\u4e2a\u8d77\u59cb\u503c\uff0c\u4f9d\u6b21\u589e\u52a0\uff0c\u73af\u5f62\u53d6\u503c\uff0c\u76f4\u5230\u83b7\u5f97\u4e00\u4e2a\u672c\u8282\u70b9\u672a\u4f7f\u7528\u7684\u8868\u540d\uff0c\u672a\u627e\u5230\u5219\u62a5\u9519\u3002</li> </ol>"},{"location":"develop/egress-cluster-gateway-policy/","title":"Index","text":""},{"location":"develop/egress-cluster-gateway-policy/#introduction","title":"Introduction","text":""},{"location":"develop/egress-cluster-gateway-policy/#crd","title":"CRD","text":""},{"location":"develop/egress-cluster-gateway-policy/#code-design","title":"Code design","text":""},{"location":"develop/egress-cluster-gateway-policy/#init","title":"Init","text":""},{"location":"develop/egress-cluster-gateway-policy/#controller","title":"Controller","text":""},{"location":"develop/egress-cluster-gateway-policy/#agent","title":"agent","text":""},{"location":"develop/egress-cluster-gateway-policy/#other","title":"Other","text":""},{"location":"develop/egress-cluster-gateway-policy/README_zh-CN/","title":"EgressClusterGatewayPolicy","text":""},{"location":"develop/egress-cluster-gateway-policy/README_zh-CN/#_1","title":"\u7b80\u4ecb","text":"<p>\u96c6\u7fa4\u7ea7\u522b\u7684 EgressClusterGatewayPolicy</p>"},{"location":"develop/egress-cluster-gateway-policy/README_zh-CN/#crd","title":"CRD","text":"<pre><code>apiVersion: egressgateway.spidernet.io/v1beta1\nkind: EgressClusterGatewayPolicy\nmetadata:\n  namespace: \"default\"\n  name: \"policy-test\"\nspec:\n  priority: 100             \n  egressGatewayName: \"eg1\"\n  egressIP:\n    ipv4: \"\"                            \n    ipv6: \"\"\n    useNodeIP: false\n  appliedTo:\n    podSelector:\n      matchLabels:    \n        app: \"shopping\"\n    podSubnet:\n    - \"172.29.16.0/24\"\n    - 'fd00:1/126'\n    namespaceSelector:      # 1\n      matchLabels:    \n        app: \"shopping\"\n  destSubnet:\n    - \"10.6.1.92/32\"\n    - \"fd00::92/128\"\n</code></pre> <ol> <li>namespaceSelector(LabelSelector): \u901a\u8fc7\u6807\u7b7e\u7b5b\u9009\u7b26\u5408\u8981\u6c42\u7684\u547d\u540d\u7a7a\u95f4</li> </ol> <p>\u5176\u4ed6\u5b57\u6bb5\u4e0e EgressGatewayPolicy \u4e00\u81f4</p>"},{"location":"develop/egress-cluster-gateway-policy/README_zh-CN/#_2","title":"\u4ee3\u7801\u8bbe\u8ba1","text":""},{"location":"develop/egress-cluster-gateway-policy/README_zh-CN/#_3","title":"\u521d\u59cb\u5316","text":""},{"location":"develop/egress-cluster-gateway-policy/README_zh-CN/#controller","title":"Controller","text":""},{"location":"develop/egress-cluster-gateway-policy/README_zh-CN/#agent","title":"agent","text":""},{"location":"develop/egress-cluster-gateway-policy/README_zh-CN/#_4","title":"\u5176\u4ed6","text":""},{"location":"develop/egress-cluster-status/","title":"Index","text":""},{"location":"develop/egress-cluster-status/#introduction","title":"Introduction","text":""},{"location":"develop/egress-cluster-status/#crd","title":"CRD","text":""},{"location":"develop/egress-cluster-status/#code-design","title":"Code design","text":""},{"location":"develop/egress-cluster-status/#init","title":"Init","text":""},{"location":"develop/egress-cluster-status/#controller","title":"Controller","text":""},{"location":"develop/egress-cluster-status/#agent","title":"agent","text":""},{"location":"develop/egress-cluster-status/#other","title":"Other","text":""},{"location":"develop/egress-cluster-status/README_zh-CN/","title":"EgressClusterStatus","text":""},{"location":"develop/egress-cluster-status/README_zh-CN/#_1","title":"\u7b80\u4ecb","text":"<p>\u4e3a\u4e86\u7b80\u5316 Egress \u7b56\u7565\u7684\u914d\u7f6e\uff0c\u5f15\u5165 Egress Ignore CIDR \u529f\u80fd\uff0c\u5141\u8bb8\u4ee5\u624b\u52a8\u548c\u81ea\u52a8\u7684\u65b9\u5f0f\u83b7\u53d6\u96c6\u7fa4\u7684 CIDR\u3002\u5f53 EgressGatewayPolicy \u7684 <code>destSubnet</code> \u5b57\u6bb5\u4e3a\u7a7a\u65f6\uff0c\u6570\u636e\u9762\u5c06\u4f1a\u81ea\u52a8\u5339\u914d EgressClusterStatus CR \u4e2d\u7684 CIDR \u4e4b\u5916\u7684\u6d41\u91cf\uff0c\u5e76\u5c06\u5176\u8f6c\u53d1\u5230 Egress \u7f51\u5173\u3002</p>"},{"location":"develop/egress-cluster-status/README_zh-CN/#crd","title":"CRD","text":"<pre><code>apiVersion: egressgateway.spidernet.io/v1beta1\nkind: EgressClusterStatus\nmetadata:\n   name: \"default\"  # 1\nstatus:\n  egressIgnoreCIDR:\n    nodeIP:\n      ipv4:\n      - \"10.6.0.1\"\n      ipv6:\n      - \"fd00::1\"\n    clusterIP:\n      ipv4:\n      - \"10.6.0.1\"\n      ipv6:\n      - \"fd00::1\"\n    podCIDR:\n      ipv4:\n      - \"10.6.0.0/24\"\n      ipv6:\n      - \"fd00::1/122\"\n</code></pre> <ol> <li>\u540d\u79f0\u4e3a <code>default</code>\uff0c\u7531\u7cfb\u7edf\u7ef4\u62a4\u53ea\u80fd\u521b\u5efa\u4e00\u4e2a;</li> <li>\u6839\u636e <code>egressIgnoreCIDR.autoDetect</code> \u914d\u7f6e\u68c0\u6d4b\u51fa\u7684\u96c6\u7fa4 CIDR \u6216 IP\u3002</li> </ol>"},{"location":"develop/egress-cluster-status/README_zh-CN/#_2","title":"\u4ee3\u7801\u8bbe\u8ba1","text":""},{"location":"develop/egress-cluster-status/README_zh-CN/#_3","title":"\u521d\u59cb\u5316","text":""},{"location":"develop/egress-cluster-status/README_zh-CN/#controller","title":"Controller","text":""},{"location":"develop/egress-cluster-status/README_zh-CN/#agent","title":"agent","text":""},{"location":"develop/egress-cluster-status/README_zh-CN/#_4","title":"\u5176\u4ed6","text":""},{"location":"develop/egress-cluster-status/README_zh-CN/#_5","title":"\u914d\u7f6e\u6587\u4ef6","text":"<p>\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\uff0c\u589e\u52a0\u5982\u4e0b\u914d\u7f6e\uff1a</p> <pre><code>feature:\n  egressIgnoreCIDR:\n    autoDetect:\n      podCIDR: \"\"     # 1\n      clusterIP: true # 2\n      nodeIP: true    # 3\n    custom:\n      - \"10.6.1.0/24\"\n</code></pre> <ol> <li>\u652f\u6301\u8bbe\u7f6e\u4e3a\u652f\u6301 kube-ovn, calico, k8s \u7b49\uff1b</li> <li>\u652f\u6301\u8bbe\u7f6e\u4e3a Service CIDR \u81ea\u52a8\u68c0\u6d4b\uff1b</li> <li>\u652f\u6301\u8bbe\u7f6e\u4e3a Node IP \u81ea\u52a8\u68c0\u6d4b\uff0c\u5f53\u65b0\u52a0\u4e00\u4e2a\u8282\u70b9\u65f6\uff0c\u81ea\u52a8\u5c06\u8282\u70b9\u7684\u7684\u6240\u6709 IP \u66f4\u65b0\u5230 EgressClusterStatus\u3002</li> </ol>"},{"location":"develop/egress-endpoint-slice/","title":"Index","text":""},{"location":"develop/egress-endpoint-slice/#introduction","title":"Introduction","text":""},{"location":"develop/egress-endpoint-slice/#crd","title":"CRD","text":""},{"location":"develop/egress-endpoint-slice/#code-design","title":"Code design","text":""},{"location":"develop/egress-endpoint-slice/#init","title":"Init","text":""},{"location":"develop/egress-endpoint-slice/#controller","title":"Controller","text":""},{"location":"develop/egress-endpoint-slice/#agent","title":"agent","text":""},{"location":"develop/egress-endpoint-slice/#other","title":"Other","text":""},{"location":"develop/egress-endpoint-slice/README_zh-CN/","title":"EgressEndpointSlice","text":""},{"location":"develop/egress-endpoint-slice/README_zh-CN/#_1","title":"\u7b80\u4ecb","text":"<p>\u805a\u5408 EgressGatewayPolicy \u5339\u914d\u4e2d\u7684\u7aef\u70b9\uff0c\u4ee5\u63d0\u9ad8\u6269\u5c55\u6027\uff0c\u4ec5\u652f\u6301 EgressGatewayPolicy \u4f7f\u7528 <code>podSelector</code> \u7684\u65b9\u5f0f\u5339\u914d Pod \u7684\u60c5\u51b5\u3002\u6bcf\u4e2a EgressEndpointSlice \u4e2d\u7684 Endpoint \u4e2a\u6570\u9ed8\u8ba4\u4e0d\u8d85\u8fc7 100\uff0c\u6700\u5927\u503c\u53ef\u4ee5\u8fdb\u884c\u8bbe\u7f6e\u3002\u662f EgressGatewayPolicy \u7684\u9644\u5c5e\u8d44\u6e90\u3002</p>"},{"location":"develop/egress-endpoint-slice/README_zh-CN/#crd","title":"CRD","text":"<pre><code>apiVersion: egressgateway.spidernet.io/v1beta1\nkind: EgressEndpointSlice\nmetadata:\n  name: \"policy-test-dx66t\"     # 1\n  namespace: \"default\"         \n  labels:\n    egressgateway.spidernet.io/egressgatewaypolicy: \"policy-test\"  # 2\n  ownerReferences:   # 3\n  - apiVersion: egressgateway.spidernet.io/v1beta1\n    blockOwnerDeletion: true\n    controller: true\n    kind: EgressGatewayPolicy\n    name: \"policy-test\"\n    uid: 1b2ec0a8-b929-4528-8f99-499f981d319e\ndata:\n  endpoints:                   # 4\n  - podName: \"web-app\"         \n    ipv4List:\n    - \"172.29.30.123\" \n    ipv6List:\n    - \"xxx\"         \n    nodeName: \"node1\"          # 5\n    uuid: \"\"\n</code></pre> <ol> <li>\u540d\u79f0\u7531 <code>policy-name-xxxxx</code> \u7ec4\u6210\uff0c\u540e\u9762 5 \u4f4d\u968f\u673a\u751f\u6210\uff1b</li> <li>\u6240\u5c5e\u7684 EgressGatewayPolicy \u540d\u79f0\uff1b</li> <li>\u521b\u5efa\u65f6\u540c\u6b65\u8bbe\u7f6e ownerReferences\uff1b</li> <li>\u5339\u914d\u4e2d\u7684 endpoints \u7684\u5217\u8868\uff1b</li> <li>Pod \u6240\u5728\u7684\u8282\u70b9\u3002</li> </ol>"},{"location":"develop/egress-endpoint-slice/README_zh-CN/#_2","title":"\u4ee3\u7801\u8bbe\u8ba1","text":""},{"location":"develop/egress-endpoint-slice/README_zh-CN/#_3","title":"\u521d\u59cb\u5316","text":""},{"location":"develop/egress-endpoint-slice/README_zh-CN/#controller","title":"Controller","text":""},{"location":"develop/egress-endpoint-slice/README_zh-CN/#agent","title":"agent","text":""},{"location":"develop/egress-endpoint-slice/README_zh-CN/#_4","title":"\u5176\u4ed6","text":""},{"location":"develop/egress-gateway/","title":"Index","text":""},{"location":"develop/egress-gateway/#introduction","title":"Introduction","text":""},{"location":"develop/egress-gateway/#crd","title":"CRD","text":""},{"location":"develop/egress-gateway/#code-design","title":"Code design","text":""},{"location":"develop/egress-gateway/#init","title":"Init","text":""},{"location":"develop/egress-gateway/#controller","title":"Controller","text":""},{"location":"develop/egress-gateway/#agent","title":"agent","text":""},{"location":"develop/egress-gateway/#other","title":"Other","text":""},{"location":"develop/egress-gateway/README_zh-CN/","title":"EgressGateway","text":""},{"location":"develop/egress-gateway/README_zh-CN/#_1","title":"\u7b80\u4ecb","text":"<p>\u7528\u4e8e\u9009\u62e9\u4e00\u7ec4\u8282\u70b9\u4f5c\u4e3a Egress \u7f51\u5173\u8282\u70b9\uff0cEgress IP \u53ef\u4ee5\u5728\u8be5\u8303\u56f4\u6d6e\u52a8\u3002\u96c6\u7fa4\u7ea7\u8d44\u6e90\u3002</p>"},{"location":"develop/egress-gateway/README_zh-CN/#crd","title":"CRD","text":"<pre><code>apiVersion: egressgateway.spidernet.io/v1beta1\nkind: EgressGateway\nmetadata:\n  name: \"eg1\"\nspec:                           \n  ranges:                       # 1\n   policy: \"Random\"             # 2\n   ipv4:                        # 3\n   - \"\"\n   ipv6:                        # 4\n   - \"\"\n  nodeSelector:                 # 5\n    selector:                   # 6\n      matchLabels:\n        egress: \"true\"\n    policy: \"AverageSelecton\"   # 7\nstatus:                         # 8\n  nodeList:                     # 9\n  - name: node1                 # 10\n    eips:                       # 11\n    - ipv4: \"\"                  # 12\n      ipv6: \"\"                  # 13\n      policies:                 # 14\n      - \"\"\n</code></pre> <ol> <li>ranges: \u8bbe\u7f6e Egress IP \u7684\u8303\u56f4\uff1b</li> <li>\u652f\u6301\u8bbe\u7f6e\u5355\u4e2a IP <code>10.6.0.1</code> \uff0c\u548c\u6bb5 <code>10.6.0.1-10.6.0.10</code> \uff0c CIDR <code>10.6.0.1/26</code>  \u7684\u65b9\u5f0f 3 \u79cd\u65b9\u5f0f\uff1b</li> <li>\u5982\u679c\u5f00\u542f\u53cc\u6808\u8981\u6c42\uff0cIPv4 \u7684\u6570\u91cf\u548c IPv6 \u7684\u6570\u91cf\u8981\u6c42\u4e00\u81f4\u3002\u7531\u4e8e\u6b64\u539f\u56e0\uff0c\u4f1a\u5bfc\u81f4\u4e0a\u9762 CIDR \u53ef\u80fd\u5e76\u4e0d\u5b9e\u7528\uff0c\u56e0\u6b64\u4f18\u5148\u7ea7\u4f18\u5148\u5b9e\u73b0\u524d 2 \u79cd\uff1b</li> <li>policy(string): EIP \u7684\u5206\u914d\u7b56\u7565\uff0c\u6682\u65f6\u53ea\u652f\u6301 <code>Random</code> \u968f\u673a\u5206\u914d</li> <li>ipv4([]string): EIP \u7684 IPV4 \u8303\u56f4</li> <li>ipv6([]string): EIP \u7684 IPV6 \u8303\u56f4</li> <li>nodeSelector: \u8bbe\u7f6e EgressGateway IP \u53ef\u6d6e\u52a8\u7684\u8282\u70b9\u8303\u56f4\u53ca\u7b56\u7565</li> <li>selector(LabelSelector): \u7b5b\u9009 EgressGateway IP \u53ef\u6d6e\u52a8\u7684\u8282\u70b9\u8303\u56f4</li> <li>policy(string): policy \u9009\u7f51\u5173\u8282\u70b9\u7684\u7b56\u7565\uff0c\u6682\u65f6\u53ea\u652f\u6301 <code>AverageSelecton</code> \u5e73\u5747\u5206\u914d</li> <li>status: \u5c55\u793a\u5176\u6240\u9009\u7f51\u5173\u8282\u70b9\u3001EIP \u3001\u88ab policy \u5f15\u7528\u60c5\u51b5</li> <li>nodeList([]EgressIPStatus): </li> <li>name(string): \u7f51\u5173\u8282\u70b9\u7684\u540d\u79f0</li> <li>eips([]Eips): \u8be5\u7f51\u5173\u8282\u70b9\u4e0a\u751f\u6548\u7684 EIP \u76f8\u5173\u4fe1\u606f</li> <li>ipv4(string): IPV4 EIP\uff0c\u5982\u679c policy \u4f7f\u7528\u8282\u70b9 IP\uff0c\u5219\u8be5\u5b57\u6bb5\u4e3a\u7a7a</li> <li>ipv6(string): IPV6 EIP\uff0cIPV6 \u4e0e IPV4 \u662f\u4e00\u4e00\u5bf9\u5e94\u7684</li> <li>policies([]string): \u4ee5\u8be5\u8282\u70b9\u4f5c\u4e3a\u7f51\u5173\u8282\u70b9\u7684 policy \u96c6\u5408</li> </ol>"},{"location":"develop/egress-gateway/README_zh-CN/#_2","title":"\u4ee3\u7801\u8bbe\u8ba1","text":""},{"location":"develop/egress-gateway/README_zh-CN/#_3","title":"\u521d\u59cb\u5316","text":""},{"location":"develop/egress-gateway/README_zh-CN/#controller","title":"Controller","text":""},{"location":"develop/egress-gateway/README_zh-CN/#egressgateway-event","title":"EgressGateway Event","text":"<ul> <li>Del\uff1a</li> <li>webhook \u5224\u65ad\u662f\u5426\u8fd8\u88ab\u5176\u4ed6 Policy \u5f15\u7528\uff0c\u5982\u679c\u5b58\u5728\u5219\u4e0d\u5141\u8bb8\u5220\u9664\u3002</li> <li> <p>\u901a\u8fc7\u4e86 webhook \u7684\u6821\u9a8c\u8bf4\u660e\u6ca1\u6709\u88ab\u5f15\u7528\uff0c\u6240\u4ee5\u7684\u89c4\u5219\u4e5f\u88ab\u6e05\u7406\uff0c\u5219\u53ef\u4ee5\u76f4\u63a5\u5220\u9664</p> </li> <li> <p>Other\uff1a</p> </li> <li>EIP \u51cf\u5c11\uff0c\u5982\u679c EIP \u88ab\u5f15\u7528\uff0c\u7981\u6b62\u4fee\u6539\u3002\u5206\u914d IPV4 \u4e0e IPV6 \u65f6\uff0c\u8981\u6c42\u4e00\u4e00\u5bf9\u5e94\uff0c\u6240\u4ee5\u4e24\u8005\u7684\u4e2a\u6570\u9700\u8981\u4e00\u81f4</li> <li>\u5982\u679c nodeSelector \u88ab\u4fee\u6539\uff0c\u4ece status \u83b7\u53d6\u65e7\u7684 Node \u4fe1\u606f\uff0c\u4e0e\u6700\u65b0\u7684 Node \u8fdb\u884c\u5bf9\u6bd4\u3002\u5c06\u5220\u9664\u8282\u70b9\u4e0a\u7684 EIP \u91cd\u65b0\u5206\u914d\u5230\u65b0\u7684 Node \u4e0a\u3002\u66f4\u65b0\u5bf9\u5e94 EgressNode \u4e2d\u7684 EIP \u4fe1\u606f\u3002</li> </ul>"},{"location":"develop/egress-gateway/README_zh-CN/#egressgatewaypolicy-event","title":"EgressGatewayPolicy Event","text":"<ul> <li>Del\uff1alist EgressEndpointSlice \u627e\u5230\u88ab\u5f15\u7528\u7684 EgressGateway\uff0c\u518d\u5bf9 policy \u4e0e EgressGateway \u89e3\u7ed1\u3002\u89e3\u7ed1\u9700\u8981\u505a\u7684\u4e8b\u60c5\u6709\uff0c\u627e\u5230\u5bf9\u5e94\u7684 EIP \u4fe1\u606f\u3002\u5982\u679c\u4f7f\u7528\u4e86 EIP\uff0c\u5219\u5224\u65ad\u662f\u5426\u9700\u8981\u56de\u6536 EIP\u3002\u5982\u679c\u6b64\u65f6 EIP \u5df2\u7ecf\u6ca1\u6709 policy \u4f7f\u7528\uff0c\u5219\u56de\u6536 EIP\uff0c\u66f4\u65b0\u81ea\u8eab\u53ca EgressNode \u7684 EIP \u4fe1\u606f</li> <li>Other\uff1a</li> <li>\u6682\u5b9a policy \u4e0d\u80fd\u4fee\u6539\u7ed1\u5b9a\u7684 EgressGateway\u3002\u5982\u679c\u5141\u8bb8\u4fee\u6539\uff0c\u5219 list EgressGateway \u627e\u5230\u539f\u5148\u7ed1\u5b9a\u7684 EgressGateway\uff0c\u8fdb\u884c\u89e3\u7ed1\u3002\u518d\u5bf9\u65b0\u7684\u8fdb\u884c\u7ed1\u5b9a\u3002</li> <li>\u65b0\u589e policy\uff0c\u5219\u5c06 policy \u4e0e EgressGateway \u8fdb\u884c\u7ed1\u5b9a\uff0c\u7ed1\u5b9a\u4e2d\uff0c\u5224\u65ad\u662f\u5426\u9700\u8981\u5206\u914d EIP</li> </ul>"},{"location":"develop/egress-gateway/README_zh-CN/#node-event","title":"Node Event","text":"<ul> <li>Del\uff1alist EgressGateway \u6311\u9009\u51fa\u5728\u8be5\u8282\u70b9\u751f\u6548\u7684 EIP\uff0c\u5c06\u8fd9\u4e9b EIP \u91cd\u65b0\u5206\u914d\u5230\u65b0\u7684\u8282\u70b9\u4e0a\u3002\u66f4\u65b0 EgressGateway \u7684 eip.policy </li> <li>Other\uff1a</li> <li>NoReady \u4e8b\u4ef6\u65f6\uff0c\u76f8\u5f53\u4e8e\u89e6\u53d1\u5220\u9664\u4e8b\u4ef6</li> <li>\u6807\u7b7e\u4fee\u6539\uff0c\u901a\u8fc7\u904d\u5386 EgressGateway \u6240\u6709\u4fe1\u606f\uff0c\u662f\u5426\u6d89\u53ca nodeSelector\u3002\u5982\u679c\u65e7\u6807\u7b7e\u4e0d\u6d89\u53ca EgressPolicy\uff0c\u5219\u4e0d\u505a\u4efb\u4f55\u5904\u7406\u3002\u5982\u679c\u6709\u6d89\u53ca\uff0c\u76f8\u5f53\u4e8e\u89e6\u53d1\u4e86\u5220\u9664\u4e8b\u4ef6\u3002\u5982\u679c\u65b0\u7684\u6807\u7b7e\u7b26\u5408 EgressGateway \u6761\u4ef6\uff0c\u5219\u66f4\u65b0\u5bf9\u5e94\u7684 EgressGateway \u7684 status \u4fe1\u606f</li> </ul>"},{"location":"develop/egress-gateway/README_zh-CN/#agent","title":"agent","text":"<p>\u65e0</p>"},{"location":"develop/egress-gateway/README_zh-CN/#_4","title":"\u5176\u4ed6","text":""},{"location":"develop/egress-gateway/README_zh-CN/#policy-eip","title":"policy \u9009\u7f51\u5173\u8282\u70b9\u53ca EIP \u5206\u914d\u903b\u8f91","text":"<p>\u4e00\u4e2a policy \u4f1a\u6839\u636e\u9009\u7f51\u5173\u8282\u70b9\u7684\u7b56\u7565\uff0c\u9009\u62e9\u4e00\u4e2a\u8282\u70b9\u4f5c\u4e3a\u7f51\u5173\u8282\u70b9\u3002\u7136\u540e\u6839\u636e\u662f\u5426\u4f7f\u7528 EIP\uff0c\u6765\u51b3\u5b9a\u662f\u5426\u5206\u914d EIP\u3002\u5206\u914d\u7684 EIP \u5c06\u7ed1\u5b9a\u5230\u6240\u9009\u7684\u7f51\u5173\u8282\u70b9\u4e0a</p> <p>\u5206\u914d\u903b\u8f91\u90fd\u662f\u4ee5\u5355\u4e2a EgressGateway \u4e3a\u5bf9\u8c61\uff0c\u800c\u4e0d\u662f\u6240\u6709\u7684 EgressGateway\u3002</p>"},{"location":"develop/egress-gateway/README_zh-CN/#policy","title":"policy \u9009\u7f51\u5173\u8282\u70b9\u7684\u6a21\u5f0f","text":"<ul> <li>\u5e73\u5747\u9009\u62e9\uff1a\u5f53\u9700\u8981\u9009\u62e9\u7f51\u5173\u8282\u70b9\u65f6\uff0c\u9009\u62e9\u4f5c\u4e3a\u7f51\u5173\u8282\u70b9\u6700\u5c11\u7684\u4e00\u4e2a\u8282\u70b9\u3002</li> <li>\u6700\u5c11\u8282\u70b9\u9009\u62e9\uff1a\u5c3d\u91cf\u9009\u540c\u4e00\u4e2a\u8282\u70b9\u4f5c\u4e3a\u7f51\u5173\u8282\u70b9</li> <li>\u9650\u5ea6\u9009\u62e9\uff1a\u4e00\u4e2a\u8282\u70b9\u6700\u591a\u53ea\u80fd\u6210\u4e3a\u51e0\u4e2a policy \u7684\u7f51\u5173\u8282\u70b9\uff0c\u9650\u5ea6\u53ef\u4ee5\u8bbe\u7f6e\uff0c\u9ed8\u8ba4\u4e3a 5\u3002\u6ca1\u6709\u8fbe\u5230\u9650\u5ea6\u524d\uff0c\u5219\u4f18\u9009\u9009\u62e9\u8be5\u8282\u70b9\uff0c\u8fbe\u5230\u9650\u5ea6\u5c31\u5148\u9009\u5176\u4ed6\u7684\u8282\u70b9\uff0c\u5982\u679c\u90fd\u8fbe\u5230\u4e86\u9650\u5ea6\uff0c\u5219\u518d\u968f\u673a\u9009\u62e9</li> </ul>"},{"location":"develop/egress-gateway/README_zh-CN/#eip","title":"EIP \u5206\u914d\u903b\u8f91","text":"<ul> <li>\u968f\u673a\u5206\u914d\uff1a\u5728\u6240\u6709\u7684 EIP \u4e2d\u968f\u673a\u9009\u62e9\u4e00\u4e2a\uff0c\u4e0d\u7ba1\u8be5 EIP \u662f\u5426\u5df2\u7ecf\u5206\u914d</li> <li>\u4f18\u5148\u4f7f\u7528\u672a\u5206\u914d\u7684 EIP\uff1a\u5148\u4f7f\u7528\u672a\u5206\u914d\u7684 EIP\uff0c\u5982\u679c\u90fd\u4f7f\u7528\u4e86\u5219\u518d\u968f\u673a\u5206\u914d\u4e00\u4e2a\u5df2\u4f7f\u7528\u7684 EIP</li> <li>\u9650\u5ea6\u9009\u62e9\uff1a\u4e00\u4e2a EIP \u6700\u591a\u53ea\u80fd\u88ab\u51e0\u4e2a policy \u4f7f\u7528\uff0c\u9650\u5ea6\u53ef\u4ee5\u8bbe\u7f6e\uff0c\u9ed8\u8ba4\u4e3a 5\uff0c\u6ca1\u6709\u8fbe\u5230\u9650\u5ea6\u524d\uff0c\u5219\u5148\u5206\u914d\u8be5 EIP\uff0c\u8fbe\u5230\u9650\u5ea6\u5219\u9009\u5176\u4ed6\u7684 EIP\u3002\u90fd\u8fbe\u5230\u9650\u5ea6\u5219\u968f\u673a\u5206\u914d\u3002</li> </ul>"},{"location":"develop/egress-gateway/README_zh-CN/#eip_1","title":"EIP \u56de\u6536\u903b\u8f91","text":"<p>\u5f53\u4e00\u4e2a EIP \u6ca1\u6709\u88ab\u4f7f\u7528\u65f6\uff0c\u5219\u56de\u6536\u8be5 EIP\uff0c\u56de\u6536\u5c31\u662f\u5728 eips \u4e2d\u5c06\u8be5 EIP \u5b57\u6bb5\u5220\u9664</p>"},{"location":"develop/egress-gateway-policy/","title":"Index","text":""},{"location":"develop/egress-gateway-policy/#introduction","title":"Introduction","text":""},{"location":"develop/egress-gateway-policy/#crd","title":"CRD","text":""},{"location":"develop/egress-gateway-policy/#code-design","title":"Code design","text":""},{"location":"develop/egress-gateway-policy/#init","title":"Init","text":""},{"location":"develop/egress-gateway-policy/#controller","title":"Controller","text":""},{"location":"develop/egress-gateway-policy/#agent","title":"agent","text":""},{"location":"develop/egress-gateway-policy/#other","title":"Other","text":""},{"location":"develop/egress-gateway-policy/README_zh-CN/","title":"EgressGatewayPolicy","text":""},{"location":"develop/egress-gateway-policy/README_zh-CN/#_1","title":"\u7b80\u4ecb","text":"<p>\u7528\u4e8e\u6307\u5b9a\u54ea\u4e9b Pod \u8d70 Egress \u7b56\u7565\uff0c\u4ee5\u53ca Egress \u6240\u4f7f\u7528\u7684 IP \u5730\u5740\u3002\u79df\u6237\u7ea7\u8d44\u6e90\u3002</p>"},{"location":"develop/egress-gateway-policy/README_zh-CN/#crd","title":"CRD","text":"<pre><code>apiVersion: egressgateway.spidernet.io/v1beta1\nkind: EgressGatewayPolicy\nmetadata:\n  namespace: \"default\"\n  name: \"policy-test\"\nspec:\n  egressGatewayName: \"eg1\"  # 1\n  egressIP:                 # 2\n    ipv4: \"\"                            \n    ipv6: \"\"\n    useNodeIP: false        # 3\n  appliedTo:                # 4\n    podSelector:            # 4-a \n      matchLabels:    \n        app: \"shopping\"\n    podSubnet:              # 4-b\n    - \"172.29.16.0/24\"\n    - 'fd00:1/126'\n  destSubnet:               # 5\n    - \"10.6.1.92/32\"\n    - \"fd00::92/128\"\n  priority: 100             # 6\n\n</code></pre> <ol> <li>\u9009\u62e9\u7b56\u7565\u5f15\u7528\u7684 EgressGateway\uff1b</li> <li>Egress IP \u51c6\u5165\u7b56\u7565\uff1b</li> <li>\u82e5\u5728\u521b\u5efa\u65f6\u5b9a\u4e49\u4e86 <code>ipv4</code> \u6216 <code>ipv6</code> \u5730\u5740\uff0c\u5219\u4ece EgressGateway \u7684 <code>.ranges</code> \u4e2d\u5206\u914d\u4e00\u4e2a IP \u5730\u5740\uff0c\u82e5\u7528\u6237\u5728 policy1 \u4e2d\uff0c\u7533\u8bf7\u4f7f\u7528\u4e86 IP \u5730\u5740 <code>10.6.1.21</code> \u548c <code>fd00:1</code> \uff0c\u7136\u540e\u521b\u5efa policy2 \u4e2d\uff0c\u7533\u8bf7\u4f7f\u7528\u4e86 IP \u5730\u5740 <code>10.6.1.21</code> \u548c <code>fd00:2</code> \uff0c\u5219\u4f1a\u62a5\u9519\uff0c\u6b64\u65f6 policy2 \u4f1a\u5206\u914d\u5931\u8d25\uff1b</li> <li>\u82e5\u672a\u5b9a\u4e49 <code>ipv4</code> \u6216 <code>ipv6</code> \u5730\u5740\uff0c\u4e14 <code>useNodeIP</code> \u4e3a true \u65f6\uff0c\u5219\u4f7f\u7528\u6240\u5f15\u7528 EgressGateway \u7684\u5339\u914d\u4e2d\u7684 Node \u7684 IP \u4f5c\u4e3a Egress \u5730\u5740\u3002</li> <li>\u82e5\u672a\u5728\u521b\u5efa\u65f6\u5b9a\u4e49 <code>ipv4</code> \u6216 <code>ipv6</code> \u5730\u5740\uff0c\u4e14 <code>useNodeIP</code> \u4e3a <code>false</code> \u65f6\u3002<ul> <li>\u5219\u81ea\u52a8\u4ece EgressGateway \u7684 <code>.ranges</code> \u4e2d\u5206\u914d\u4e00\u4e2a IP \u5730\u5740\uff08\u5f00\u542f IPv6 \u65f6\uff0c\u8bf7\u6c42\u5206\u914d\u4e00\u4e2a IPv4 \u548c \u4e00\u4e2a IPv6 \u5730\u5740\uff09\uff1b</li> </ul> </li> <li><code>egressGatewayName</code> \u4e0d\u80fd\u4e3a\u7a7a</li> <li>\u652f\u6301\u4f7f\u7528\u8282\u70b9 IP \u4f5c\u4e3a Egress IP\uff08\u53ea\u5141\u8bb8\u9009\u62e9\u4e00\u79cd\uff09\uff1b</li> <li>\u9009\u62e9\u9700\u8981\u5e94\u7528 Egress Gateway Policy \u7684 Pod\uff1b    a. \u4ee5 Label \u7684\u65b9\u5f0f\u8fdb\u884c\u9009\u62e9    b. \u76f4\u63a5\u6307\u5b9a Pod \u7684\u7f51\u6bb5 \uff08a \u548c b \u4e0d\u80fd\u540c\u65f6\u4f7f\u7528\uff09</li> <li>\u6307\u5b9a\u8bbf\u95ee Egress \u7684\u76ee\u6807\u5730\u5740\uff0c\u82e5\u672a\u6307\u5b9a\u76ee\u6807\u5730\u5740\uff0c\u5219\u751f\u6548\u7684\u7b56\u7565\u4f4d\u76ee\u6807\u5730\u5740\u975e\u96c6\u7fa4\u5185 CIDR \u65f6\uff0c\u5168\u90e8\u8f6c\u53d1\u5230 Egress \u8282\u70b9\u3002</li> <li>\u7b56\u7565\u7684\u4f18\u5148\u7ea7</li> </ol>"},{"location":"develop/egress-gateway-policy/README_zh-CN/#_2","title":"\u4ee3\u7801\u8bbe\u8ba1","text":""},{"location":"develop/egress-gateway-policy/README_zh-CN/#_3","title":"\u521d\u59cb\u5316","text":""},{"location":"develop/egress-gateway-policy/README_zh-CN/#controller","title":"Controller","text":""},{"location":"develop/egress-gateway-policy/README_zh-CN/#agent","title":"agent","text":""},{"location":"develop/egress-gateway-policy/README_zh-CN/#_4","title":"\u5176\u4ed6","text":""},{"location":"develop/egress-node/","title":"Index","text":""},{"location":"develop/egress-node/#introduction","title":"Introduction","text":""},{"location":"develop/egress-node/#crd","title":"CRD","text":""},{"location":"develop/egress-node/#code-design","title":"Code design","text":""},{"location":"develop/egress-node/#init","title":"Init","text":""},{"location":"develop/egress-node/#controller","title":"Controller","text":""},{"location":"develop/egress-node/#agent","title":"agent","text":""},{"location":"develop/egress-node/#other","title":"Other","text":""},{"location":"develop/egress-node/README_zh-CN/","title":"EgressNode","text":""},{"location":"develop/egress-node/README_zh-CN/#_1","title":"\u7b80\u4ecb","text":"<p>\u4e3b\u8981\u7528\u4e8e\u8bb0\u5f55\u8de8\u8282\u70b9\u901a\u4fe1\u7684\u96a7\u9053\u7f51\u5361\u4fe1\u606f\u3002\u96c6\u7fa4\u7ea7\u8d44\u6e90\uff0c\u4e0e Kubernetes Node \u8d44\u6e90\u540d\u79f0\u4e00\u4e00\u5bf9\u5e94\u3002</p>"},{"location":"develop/egress-node/README_zh-CN/#crd","title":"CRD","text":"<pre><code>apiVersion: egressgateway.spidernet.io/v1beta1\nkind: EgressNode\nmetadata:\n   name: \"node1\"\nstatus:\n   tunnel:\n      ipv4: \"192.200.222.157\"  # 1\n      ipv6: \"fd01::f2\"         # 2        \n      mac: \"66:50:85:cb:b2:bf\" # 3\n      parent:\n         name: \"ens160\"        # 4\n         ipv4: \"10.6.1.21/16\"  # 5\n         ipv6: \"fd00::21/112\"  # 6\n   phase: \"Succeeded\"          # 7\n   mark: \"0x26000000\"          # 8\n</code></pre> <ol> <li>\u96a7\u9053 IPv4 \u5730\u5740</li> <li>\u96a7\u9053 IPv6 \u5730\u5740</li> <li>\u96a7\u9053 MAC \u5730\u5740</li> <li>\u96a7\u9053\u7236\u7f51\u5361</li> <li>\u96a7\u9053\u7236\u7f51\u5361 IPv4 \u5730\u5740</li> <li>\u96a7\u9053\u7236\u7f51\u5361 IPv6 \u5730\u5740</li> <li>\u5f53\u524d\u96a7\u9053\u5c31\u7eea\u9636\u6bb5\uff0c<code>Succeeded</code> \u96a7\u9053IP\u5df2\u5206\u914d\uff0c\u4e14\u96a7\u9053\u5df2\u5efa\u6210\uff0c<code>Pending</code> \u7b49\u5f85\u5206\u914dIP\uff0c<code>Init</code> \u5206\u914d\u96a7\u9053 IP \u6210\u529f\uff0c<code>Failed</code> \u96a7\u9053 IP \u5206\u914d\u5931\u8d25</li> <li>mark \u503c\uff0c\u6b64\u4e3a\u65b0\u589e\u6b64\u6bb5\uff0c\u521b\u5efa\u65f6\u751f\u6210\u3002\u6bcf\u4e2a\u8282\u70b9\u5bf9\u5e94\u4e00\u4e2a\uff0c\u5168\u5c40\u552f\u4e00\u7684\u6807\u7b7e\u3002\u6807\u7b7e\u7531\u524d\u7f00 + \u552f\u4e00\u6807\u8bc6\u7b26\u751f\u6210\u3002\u6807\u7b7e\u683c\u5f0f\u5982\u4e0b <code>NODE_MARK = 0x26 + value + 0000</code>\uff0c<code>value</code> \u4e3a 16 \u4f4d\uff0c\u652f\u6301\u7684\u8282\u70b9\u603b\u6570\u4e3a <code>2^16</code>\u3002\u5728\u4e0b\u53d1 policy \u89c4\u5219\u65f6\u6240\u6253\u7684\u6807\u7b7e\uff0c\u53d6\u51b3\u4e8e\u8be5\u89c4\u5219\u7684\u7f51\u5173\u8282\u70b9\u3002</li> </ol>"},{"location":"develop/egress-node/README_zh-CN/#_2","title":"\u4ee3\u7801\u8bbe\u8ba1","text":""},{"location":"develop/egress-node/README_zh-CN/#controller","title":"Controller","text":""},{"location":"develop/egress-node/README_zh-CN/#_3","title":"\u521d\u59cb\u5316","text":"<ol> <li>\u4ece CM \u4e2d\u83b7\u53d6\u53cc\u6808\u5f00\u542f\u60c5\u51b5\u53ca\u5bf9\u5e94\u7684\u96a7\u9053 CIDR</li> <li>\u901a\u8fc7\u8282\u70b9\u540d\u79f0\u6839\u636e\u7b97\u6cd5\u751f\u6210\u552f\u4e00\u7684\u6807\u7b7e\u503c</li> <li>\u4f1a\u68c0\u67e5 node \u662f\u5426\u6709\u5bf9\u5e94\u7684 EgressNode\uff0c\u6ca1\u6709\u7684\u8bdd\u5c31\u521b\u5efa\u5bf9\u5e94\u7684EgressNode\uff0c\u4e14\u72b6\u6001\u8bbe\u7f6e\u4e3a <code>Pending</code>\u3002\u6709\u96a7\u9053 IP \u5219\u5c06 IP \u4e0e\u8282\u70b9\u7ed1\u5b9a\uff0c\u7ed1\u5b9a\u524d\u4f1a\u68c0\u67e5 IP \u662f\u5426\u5408\u6cd5\uff0c\u4e0d\u5408\u6cd5\u5219\u5c06\u72b6\u6001\u8bbe\u7f6e\u4e3a <code>Pending</code></li> </ol>"},{"location":"develop/egress-node/README_zh-CN/#egressnode-event","title":"EgressNode Event","text":"<ul> <li>Del\uff1a\u5148\u91ca\u653e\u96a7\u9053 IP\uff0c\u518d\u5220\u9664\u3002\u5982\u679c EgressNode \u5bf9\u5e94\u7684\u8282\u70b9\u8fd8\u5b58\u5728\uff0c\u91cd\u65b0\u521b\u5efa EgressNode</li> <li>Other\uff1a</li> <li>phase != <code>Init</code> || phase != <code>Succeeded</code>\uff1a\u5219\u5206\u914d IP\uff0c\u5206\u914d\u6210\u529f\u5c06\u72b6\u6001\u8bbe\u7f6e\u4e3a <code>Init</code>\uff0c\u5206\u914d\u5931\u8d25\u5c06\u72b6\u6001\u8bbe\u7f6e\u4e3a <code>Failed</code>\u3002\u8fd9\u91cc\u662f\u5168\u5c40\u552f\u4e00\u4f1a\u5206\u914d\u96a7\u9053 IP \u7684\u5730\u65b9</li> <li>mark != algorithm(NodeName)\uff1a\u8be5\u5b57\u6bb5\u7981\u6b62\u4fee\u6539\uff0c\u76f4\u63a5\u62a5\u9519\u8fd4\u56de</li> </ul>"},{"location":"develop/egress-node/README_zh-CN/#node-event","title":"Node Event","text":"<ul> <li>Del\uff1a\u5220\u9664\u5bf9\u5e94\u7684 EgressNode</li> <li>Other\uff1a</li> <li>\u8282\u70b9\u5bf9\u5e94\u7684 EgressNode \u4e0d\u5b58\u5728\uff0c\u5219\u521b\u5efa EgressNode</li> <li>\u65e0\u96a7\u9053 IP\uff0c\u8bbe\u7f6e phase == <code>Pending</code></li> <li>\u6709\u96a7\u9053 IP\uff0c\u6821\u9a8c\u96a7\u9053\u662f\u5426\u5408\u6cd5\uff0c\u4e0d\u5408\u6cd5\u5219\u8bbe\u7f6e phase == <code>Pending</code></li> <li>\u96a7\u9053 IP \u5408\u6cd5\uff0c\u6821\u9a8c IP \u662f\u5426\u5206\u914d\u7ed9\u672c\u8282\u70b9\uff0c\u4e0d\u662f\u5219\u8bbe\u7f6e phase == <code>Pending</code>\u3002</li> <li>\u96a7\u9053 IP \u662f\u5206\u914d\u7ed9\u672c\u8282\u70b9\uff0cphase != <code>Succeeded</code> \u5219\u8bbe\u7f6e phase == <code>Init</code></li> </ul>"},{"location":"develop/egress-node/README_zh-CN/#agent","title":"agent","text":""},{"location":"develop/egress-node/README_zh-CN/#_4","title":"\u521d\u59cb\u5316","text":""},{"location":"develop/egress-node/README_zh-CN/#_5","title":"\u5176\u4ed6","text":""},{"location":"proposal/01-egress-gateway/EgressGateway/","title":"EgressGateway","text":""},{"location":"proposal/01-egress-gateway/EgressGateway/#crds","title":"CRDS","text":"<p>The egress gateway model abstracts three Custom Resource Definitions (CRDs): <code>EgressNode</code> , <code>EgressNode</code> and <code>EgressGatewayPolicy</code>. They are cluster scoped CRDs.</p>"},{"location":"proposal/01-egress-gateway/EgressGateway/#egressgateway_1","title":"EgressGateway","text":"<pre><code>apiVersion: egressgateway.spidernet.io/v1\nkind: EgressGateway\nmetadata:\n  name: \"egressgateway\"\nspec:\n  nodeSelector:\n    matchLabels:\n      egress: \"true\"\nstatus:\n  forwardMethod: \"active-passive\"\n  nodeList: \n    - node1:\n        status: \"ready\"\n        active: true\n        interfaces:\n        - eth0:\n            ipv4: [\"10.6.0.10/16\"]\n            ipv6: [\"fd::10/64\"]\n</code></pre> <ul> <li>spec<ul> <li><code>nodeSelector</code> field matching against node labels.</li> </ul> </li> <li>status<ul> <li><code>forwardMethod</code> field sync form <code>ConfigMap</code> configuration.</li> <li><code>nodeList</code> field is the list of nodes matched by <code>nodeSelector</code><ul> <li><code>status</code> field represents the node status, which may be <code>Ready</code>, <code>NotReady</code> or <code>Unknown</code>.<ul> <li>Only nodes in the <code>Ready</code> state can participate in the election of egress gateway nodes.</li> </ul> </li> <li><code>avtive</code> field represents that the non-egress gateway is reconcile or reconcile completes accessing the destination CIDR(e.g. Cluster A CIDR in picture 1) with this node.</li> <li><code>interfaces</code> is physical network interface list. It is updated by the Agent.<ul> <li><code>ipv4</code> address list.</li> <li><code>ipv6</code> address list.</li> </ul> </li> </ul> </li> </ul> </li> </ul>"},{"location":"proposal/01-egress-gateway/EgressGateway/#egressnode","title":"EgressNode","text":"<pre><code>apiVersion: egressgateway.spidernet.io/v1\nkind: EgressNode\nmetadata:\n  name: \"node1\"\nspec:\nstatus:\n  phase: \"Succeeded\"\n  vxlanIPv4IP: \"172.31.0.10/16\"\n  vxlanIPv6IP: \"fe80::/64\"\n  tunnelMac: \"xx:xx:xx:xx:xx\"\n  physicalInterface: \"eth1\"\n  physicalInterfaceIPv4: \"\"\n  physicalInterfaceIPv6: \"\"\n</code></pre> <p>The <code>EgressNode</code> CRD stores vxlan tunnel information, which is generated by the Controller from the Node CR.</p> <ul> <li>status<ul> <li><code>phase</code> indicates the status of EgressNode. If 'Succeeded' has been assigned and the tunnel has been built, 'Pending' is waiting for IP assignment, 'Init' succeeds in assigning the tunnel IP address, and 'Failed' fails to assign the tunnel IP address.</li> <li><code>vxlanIPv4IP</code> field represents the IPv4 address of VXLAN tunnel.</li> <li><code>vxlanIPv6IP</code> field represents the IPv6 address of VXLAN tunnel.</li> <li><code>tunnelMac</code> field represents the MAC address of IPv4 VXLAN tunnel Interface.</li> <li><code>physicalInterface</code> is parent name of VXLAN tunnel interface.</li> <li><code>physicalInterfaceIPv4</code> is parent IPv4 Address of VXLAN tunnel interface.</li> <li><code>physicalInterfaceIPv6</code> is parent IPv6 Address of VXLAN tunnel interface.</li> </ul> </li> </ul>"},{"location":"proposal/01-egress-gateway/EgressGateway/#egressgatewaypolicy","title":"EgressGatewayPolicy","text":"<pre><code>apiVersion: egressgateway.spidernet.io/v1\nkind: EgressGatewayPolicy\nmetadata:\n  name: \"policy\"\nspec:\n  appliedTo:\n    podSelector:\n      matchLabels:\n        app: \"shopping\"\n      ipv6PodSubnet: \"10.0.0.0/16\"\n      ipv4PodSubnet: \"10.0.0.0/16\"\n  destCIDR: \n   - \"10.6.1.0/24\"\n</code></pre> <ul> <li>spec<ul> <li><code>podSelector</code> filed selects the grouping of pods to which the policy applies.</li> <li><code>podSubnet</code> field specifies the pod CIDR affected by the egress policy. It conflicts with the <code>podSelector</code> field.</li> <li><code>destCIDR</code> destination CIDR block list.</li> </ul> </li> </ul>"},{"location":"proposal/01-egress-gateway/EgressGateway/#datapath","title":"Datapath","text":"<p>A combination of vxlan tunnel, ipset, iptables, route is required to complete policy control.</p>"},{"location":"proposal/01-egress-gateway/EgressGateway/#non-egress-node","title":"Non Egress Node","text":""},{"location":"proposal/01-egress-gateway/EgressGateway/#vxlan","title":"VXLAN","text":"<p>Build a VXLAN tunnel on cluster nodes. There are 2 tunnel NICs named <code>egress-vxlan-v4</code> and <code>egress-vxlan-v6</code>.</p>"},{"location":"proposal/01-egress-gateway/EgressGateway/#ipset","title":"IPSet","text":"<pre><code>sudo ipset create egress-dst-policy-name\nsudo ipset add egress-dest-policy-name 172.16.1.1/32\n</code></pre>"},{"location":"proposal/01-egress-gateway/EgressGateway/#iptables","title":"IPTables","text":"<pre><code>iptables -t mangle -F EGRESSGATEWAY-MARK-REQUEST-POLICY-NAME\niptables -t mangle -X EGRESSGATEWAY-MARK-REQUEST-POLICY-NAME\niptables -t mangle -N EGRESSGATEWAY-MARK-REQUEST-POLICY-NAME\n\niptables -A EGRESSGATEWAY-MARK-REQUEST-POLICY-NAME \\\n  -t mangle \\\n  -m conntrack --ctdir ORIGINAL \\\n  -m set --match-set egress-dst-policy-name dst \\\n  -m set --match-set egress-src-policy-name src \\\n  -j MARK --set-mark 0x11000000 \\\n  -m comment --comment \"rule uuid: mark request packet\"\n</code></pre>"},{"location":"proposal/01-egress-gateway/EgressGateway/#route","title":"Route","text":"<p>Normal.</p> <pre><code>ip rule add fwmark 0x11000000 table 100\nip route f table 100\nip route add default via 20.0.0.85 dev egress-vxlan-v4 onlink table 100\n</code></pre> <p>Equal-cost multi-path routing.</p> <pre><code>sysctl -w net.ipv4.fib_multipath_hash_policy=1\n</code></pre> <pre><code>ip rule add fwmark 0x11000000 table 100\nip route f table 100\nip route add table 100 default \\\n  nexthop via 20.0.0.85 dev egress-vxlan onlink \\\n  nexthop via 20.0.0.90 dev egress-vxlan onlink\n</code></pre>"},{"location":"proposal/01-egress-gateway/EgressGateway/#egress-node","title":"Egress Node","text":"<pre><code>iptables -t mangle -I FORWARD 1 -m mark --mark 0x11000000 -j MARK --set-mark 0x12000000 -m comment --comment \"egress gateway: change mark\"\niptables -t filter -I FORWARD 1 -m mark --mark 0x12000000 -j ACCEPT -m comment --comment \"egress gateway: keep mark\"\niptables -t filter -I OUTPUT 1 -m mark --mark 0x12000000 -j ACCEPT -m comment --comment \"egress gateway: keep mark\"\niptables -t mangle -I POSTROUTING 1 -m mark --mark 0x12000000 -j ACCEPT -m comment --comment \"egress gateway: keep mark\"\niptables -t nat -I POSTROUTING 1 -m mark --mark 0x12000000 -j ACCEPT -m comment --comment \"egress gateway: no snat\"\n</code></pre>"},{"location":"proposal/01-egress-gateway/EgressGateway/#implementation","title":"Implementation","text":""},{"location":"proposal/01-egress-gateway/EgressGateway/#controller","title":"Controller","text":"<p>Controller consists of Webhook Validator and Reconcile Flow.</p> <p></p> <p>Controller has 2 control processes, the first Watch cluster nodes, generate tunnel IP address and MAC address for Node, then <code>Create</code> or <code>Update</code> EgressNode CR Status. The second control flow watch <code>EgressNode</code> and <code>Egressgateway</code>, sync match node list from <code>labelSelector</code>, election egress gateway node.</p>"},{"location":"proposal/01-egress-gateway/EgressGateway/#agent","title":"Agent","text":"<p>Agent has two control processes, the first Watch <code>EgressNode</code> CR, which manages node tunnel, and node tunnel is a pluggable interface that can be replaced by Geneve. The second control process manages datapath policy, which watches <code>EgressNode</code>, <code>EgressGateway</code> and <code>Egresspolicy</code>, and sends them to the host through the police interface. It is currently implemented by a combination of ipset, iptables, and route, and it can be replaced by eBPF.</p>"},{"location":"proposal/02-egress-node/EgressNode-zh_CN/","title":"EgressNode zh CN","text":""},{"location":"proposal/02-egress-node/EgressNode-zh_CN/#egressnode-crd","title":"EgressNode CRD","text":"<pre><code>apiVersion: egressgateway.spidernet.io/v1\nkind: EgressNode\nmetadata:\n  name: \"node1\"\nspec:\nstatus:\n  phase: \"Succeeded\"\n  vxlanIPv4IP: \"172.31.0.10/16\"\n  vxlanIPv6IP: \"fe80::/64\"\n  tunnelMac: \"xx:xx:xx:xx:xx\"\n  physicalInterface: \"eth1\"\n  physicalInterfaceIPv4: \"\"\n  physicalInterfaceIPv6: \"\"\n</code></pre> <p>\u7528\u4ee5\u5b58\u50a8\u5404\u8282\u70b9\u7684\u96a7\u9053\u7684\u4fe1\u606f\uff0c\u901a\u8fc7\u76d1\u63a7\u8282\u70b9\u6765\u751f\u6210</p> <p>\u5b57\u6bb5\u8bf4\u660e * status     * <code>phase</code> \u8868\u793a EgressNode  \u7684\u72b6\u6001\uff0c\u2019Succeeded\u2019 \u96a7\u9053IP\u5df2\u5206\u914d\uff0c\u4e14\u96a7\u9053\u5df2\u5efa\u6210\uff0c\u2019Pending\u2019 \u7b49\u5f85\u5206\u914dIP\uff0c\u2019Init\u2019 \u5206\u914d\u96a7\u9053 IP \u6210\u529f\uff0c\u2019Failed\u2019 \u96a7\u9053 IP \u5206\u914d\u5931\u8d25     * <code>vxlanIPv4IP</code> \u96a7\u9053 IPV4 \u5730\u5740     * <code>vxlanIPv6IP</code> \u96a7\u9053 IPV6 \u5730\u5740     * <code>tunnelMac</code> \u96a7\u9053 Mac \u5730\u5740     * <code>physicalInterface</code> \u96a7\u9053\u7236\u7f51\u5361     * <code>physicalInterfaceIPv4</code> \u7236\u7f51\u5361 IPV4 \u5730\u5740     * <code>physicalInterfaceIPv6</code> \u7236\u7f51\u5361 IPV6 \u5730\u5740</p>"},{"location":"proposal/02-egress-node/EgressNode-zh_CN/#controller","title":"controller \u5b9e\u73b0","text":""},{"location":"proposal/02-egress-node/EgressNode-zh_CN/#_1","title":"\u521d\u59cb\u5316","text":"<ol> <li>\u4ece CM\u4e2d\u83b7\u53d6 IPv4\u3001IPv6 \u53ca\u5bf9\u5e94\u7684 CIDR</li> <li>\u4f1a\u68c0\u67e5node \u662f\u5426\u6709\u5bf9\u5e94\u7684 EgressNode\uff0c\u6ca1\u6709\u7684\u8bdd\u5c31\u521b\u5efa\u5bf9\u5e94\u7684EgressNode\uff0c\u4e14\u72b6\u6001\u8bbe\u7f6e\u4e3a \u201cpending\u201d\u3002\u6709\u96a7\u9053 IP \u5219\u5c06 IP \u4e0e\u8282\u70b9\u7ed1\u5b9a\uff0c\u7ed1\u5b9a\u524d\u4f1a\u68c0\u67e5 IP \u662f\u5426\u5408\u6cd5\uff0c\u4e0d\u5408\u6cd5\u5219\u5c06\u72b6\u6001\u8bbe\u7f6e\u4e3a \u201cPending\u201d</li> </ol>"},{"location":"proposal/02-egress-node/EgressNode-zh_CN/#_2","title":"\u8282\u70b9\u4e8b\u4ef6\uff1a","text":"<ul> <li>\u5220\u9664\u4e8b\u4ef6\uff1a\u5220\u9664\u5bf9\u5e94\u7684 EgressNode</li> <li>\u5176\u4ed6\u4e8b\u4ef6\uff1a\u5982\u679c\u6ca1\u6709\u5bf9\u5e94\u7684 EgressNode\uff0c\u5219\u521b\u5efa EgressNode</li> <li> <p>\u5176\u4ed6\u4e8b\u4ef6\uff1a\u5982\u679c\u6709\u5bf9\u5e94\u7684 EgressNode\uff0c\u5219\u5bf9EgressNode\u8fdb\u884c\u6821\u9a8c\u3002\u6821\u9a8c\u903b\u8f91\u5982\u4e0b\uff1a</p> </li> <li> <ul> <li>\u65e0\u96a7\u9053IP\uff0c\u5c06\u72b6\u6001\u7f6e\u4e3a \u201cPending\u201d         \u5982\u679c\u6709\u96a7\u9053IP\uff0c\u5224\u65ad\u662f\u5426\u5408\u6cd5\uff0c\u4e0d\u5408\u6cd5\uff0c\u5c31\u5c06\u72b6\u6001\u7f6e\u4e3a \u201cPending\u201d         \u5982\u679c\u5408\u6cd5\uff0c\u6821\u9a8c IP \u662f\u5426\u5df2\u5206\u914d\uff0c\u5982\u679c\u5df2\u5206\u914d\uff0c\u4e14\u5206\u914d\u7ed9\u5176\u4ed6\u8282\u70b9\u4e86\uff0c\u5219\u5c06\u72b6\u6001\u7f6e\u4e3a \u201cPending\u201d         \u672a\u5206\u914d\u7ed9\u5176\u4ed6\u8282\u70b9\uff0c\u5c31\u5206\u914d\u7ed9\u672c \u201cEgressNode\u201d\uff0c\u5c06\u72b6\u6001\u8bbe\u7f6e\u4e3a \u201cInit\u201d         \u5982\u679c\u5df2\u5206\u914d\uff0c\u4e14\u5c31\u662f\u5206\u914d\u7ed9\u672c\u8282\u70b9\u7684\uff0c\u5219\u5c06\u72b6\u6001\u8bbe\u7f6e\u4e3a \u201cInit\u201d</li> </ul> </li> </ul>"},{"location":"proposal/02-egress-node/EgressNode-zh_CN/#egressnode","title":"EgressNode\u4e8b\u4ef6\uff1a","text":"<ul> <li>\u5220\u9664\u4e8b\u4ef6\uff1a\u5148\u91ca\u653eIP\u3002\u5982\u679c EgressNode \u5bf9\u5e94\u7684\u8282\u70b9\u5b58\u5728\uff0c\u5219\u91ca\u653eIP\uff0c\u91cd\u65b0\u521b\u5efa EgressNode\u3002</li> <li>\u5176\u4ed6\u4e8b\u4ef6\uff1a\u5982\u679c EgressNode \u72b6\u6001\u4e3a \u201cInit\u201d \u6216 \u8005\u201cSucceeded\u201d \u65f6\uff0c\u4e0d\u505a\u4efb\u4f55\u5904\u7406\u3002\u5982\u679c\u4e0d\u662f\uff0c\u5219\u5206\u914d IP\uff0c\u5206\u914d\u6210\u529f\u5c06\u72b6\u6001\u8bbe\u7f6e\u4e3a \u201cInit\u201d\uff0c\u5206\u914d\u5931\u8d25\u5c06\u72b6\u6001\u8bbe\u7f6e\u4e3a \u201cFailed\u201d\u3002\u8fd9\u91cc\u662f\u5168\u5c40\u552f\u4e00\u4f1a\u5206\u914d\u96a7\u9053 IP \u7684\u5730\u65b9</li> </ul>"},{"location":"proposal/02-egress-node/EgressNode-zh_CN/#ip","title":"\u5206\u914d\u96a7\u9053 IP","text":"<ul> <li>controller \u542f\u52a8\u65f6\uff0c\u4ece config \u4e2d\u62ff\u5230\u96a7\u9053 IP CRID\uff0c\u5e76\u5728\u5185\u5b58\u4e2d\u7ef4\u62a4\u4e00\u4e2a map \u8bb0\u5f55 IP \u662f\u5426\u88ab\u5206\u914d</li> <li>\u96a7\u9053 IP \u91c7\u7528\u4e2d\u5fc3\u5f0f\uff0c\u6240\u4ee5\u4f7f\u7528\u4e32\u884c\u65b9\u5f0f\u5206\u914dIP\uff0c\u5728\u672a\u5206\u914d\u7684 IP \u4e2d\u968f\u673a\u5206\u914d</li> <li>\u5206\u914d\u524d\uff0c\u68c0\u6d4b\u96a7\u9053 IP \u51b2\u7a81\uff0c\u4e0d\u51b2\u7a81\u518d\u5206\u914d\uff08\u5b9e\u73b0\u65b9\u5f0f\u5f85\u5b9a\uff09</li> </ul>"},{"location":"proposal/02-egress-node/EgressNode-zh_CN/#_3","title":"\u5176\u4ed6","text":"<ul> <li>controller \u542f\u52a8\u65f6\uff0c\u5bf9\u6240\u7684 CRD \u7684 IP \u8fdb\u884c\u6821\u9a8c\uff0c\u4e14\u6700\u7ec8\u72b6\u6001\u8bbe\u7f6e\u4e3a \u201cInit\u201d \u6216 \u201cFailed\u201d \uff08\u6b64\u9879\u5f85\u5546\u69b7\uff09</li> <li>agent \u76d1\u6d4b\u5230\u5bf9\u5e94\u7684 CRD \u4e2d phase \u5b57\u6bb5\u4e3a \u201cInit\u201d \u65f6\uff0c\u521b\u5efa\u76f8\u5e94\u7684\u96a7\u9053\u53ca\u8def\u7531\uff0c\u521b\u5efa\u6210\u529f\u66f4\u65b0\u4e3a \u201cSucceeded\u201d \u72b6\u6001\u3002\u5931\u8d25\u5219\u4e0d\u66f4\u65b0</li> <li>Mac\u5730\u5740\u683c\u5f0f\uff1a\u6839\u636e\u8282\u70b9\u540d\u79f0\uff0c\u7ecf\u8fc7 SHA1 \u7b97\u6cd5\u751f\u6210\uff0c\u6240\u4ee5\u6bcf\u4e2a\u8282\u70b9\u7684 Mac \u5730\u5740\u662f\u56fa\u5b9a\u7684</li> </ul>"},{"location":"proposal/03-egress-ip/README_zh-CN/","title":"Egress IP","text":""},{"location":"proposal/03-egress-ip/README_zh-CN/#_1","title":"\u6982\u8981","text":"<p>\u66f4\u65b0 EgressGateway CRD \u5b57\u6bb5\u4ee5\u652f\u6301\u8bbe\u7f6e EIP \u8303\u56f4\uff0c\u8c03\u6574 EgressGatewayEgressPolicy \u4e3a\u79df\u6237\u7ea7\uff0c\u53ef\u4ee5\u9009\u62e9\u5f15\u7528\u7684 EgressGateway\uff0cEgressGateway CRD \u589e\u52a0\u5b57\u6bb5\u9650\u5236\u88ab\u5f15\u7528\u7684\u79df\u6237\u3002\u4ee5\u4e0a\u8c03\u6574\u53ef\u4ee5\u5141\u8bb8\u4e0d\u540c\u7684 EgressGatewayPolicy \u5206\u914d\u5230\u4e0d\u540c\u7684 EIP\uff0c\u53ef\u4ee5\u6839\u636e\u4e0d\u540c\u9700\u6c42\u7075\u6d3b\u89c4\u5212\u670d\u52a1\u7075\u6d3b\u89c4\u5212\u96c6\u7fa4\u51fa\u53e3\u7f51\u7edc\uff0c\u79df\u6237\u7ea7\u7684\u8d44\u6e90\u53ef\u4ee5\u8ba9\u4e0d\u540c\u7684\u89d2\u8272\u8fdb\u884c\u51fa\u53e3\u7b56\u7565\u7ba1\u7406\u3002\u589e\u52a0 EgressEndpointSlice CRD \u805a\u5408\u96c6\u7fa4\u7b56\u7565\u5339\u914d\u4e2d\u7684\u5de5\u4f5c\u8d1f\u8f7d\uff0c\u63d0\u5347 EgressGateway \u7684\u6269\u5c55\u6027\u4e0e\u6027\u80fd\u3002</p>"},{"location":"proposal/03-egress-ip/README_zh-CN/#_2","title":"\u52a8\u673a","text":"<p>\u5f53\u524d\u5df2\u7ecf\u53d1\u5e03 EgressGateway v0.1.0 \u652f\u6301\u4f7f\u7528 Egress Gateway \u7684\u8282\u70b9 IP \u4f5c\u4e3a\u51fa\u53e3 IP\uff0c\u5b83\u6ee1\u8db3\u4e86\u5c06\u9700\u8981\u51fa\u96c6\u7fa4\u7684\u670d\u52a1\u7684\u6d41\u91cf\u805a\u5408\u80fd\u529b\u3002\u4e00\u4e2a\u96c6\u7fa4\u4e2d\u901a\u5e38\u5b58\u5728\u6570\u5341\u7ec4\u751a\u81f3\u6570\u767e\u7ec4\u4e0d\u901a\u7684\u670d\u52a1\uff0c\u5176\u4e2d\u591a\u7ec4\u5e94\u7528\u9700\u8981\u8bbf\u95ee\u4e0d\u540c\u5916\u90e8\u7f51\u7edc\uff0c\u5355\u4e2a EIP \u5728\u7279\u5b9a\u7684\u9650\u5236\u6216\u89c4\u5219\u4e0b\u663e\u5f97\u6349\u895f\u89c1\u8098\uff0c\u6bd4\u5982\u4e0d\u540c EIP \u7684\u5177\u6709\u4e0d\u901a\u7684\u9632\u706b\u5899\u7b56\u7565\uff0c\u4e0d\u540cEIP \u5177\u6709\u4e0d\u540c\u7684\u8bbf\u95ee\u5e26\u5bbd\u3002\u901a\u8fc7 EgressGatewayPolicy \u4e3a\u4e0d\u540c\u7684\u5e94\u7528\u6216\u670d\u52a1\u5206\u914d\u4e0d\u540c\u7684 EIP \u4e5f\u53ef\u4ee5\uff0c\u53ef\u4ee5\u7ec6\u7c92\u5ea6\u7ba1\u7406\uff0c\u80fd\u907f\u514d\u6f5c\u5728\u7684\u5b89\u5168\u95ee\u9898\u3002</p>"},{"location":"proposal/03-egress-ip/README_zh-CN/#_3","title":"\u76ee\u6807","text":"<ul> <li>\u652f\u6301\u8bbe\u7f6e Egress IP \u8303\u56f4</li> <li>\u652f\u6301\u8bbe\u7f6e\u79df\u6237\u7ea7 EgressGatewayPolicy</li> <li>\u63d0\u5347 EgressGateway \u7684\u6027\u80fd\u548c\u53ef\u6269\u5c55\u6027</li> <li>\u66f4\u6539\u6d89\u53ca\u7684\u914d\u7f6e\u53c2\u6570\u66f4\u65b0</li> </ul>"},{"location":"proposal/03-egress-ip/README_zh-CN/#_4","title":"\u975e\u76ee\u6807","text":"<ul> <li>\u63d0\u5347\u6570\u636e\u9762\u8f6c\u53d1\u6027\u80fd</li> <li>\u66f4\u65b0\u9879\u76ee\u6587\u6863\u7ed3\u6784</li> </ul>"},{"location":"proposal/03-egress-ip/README_zh-CN/#_5","title":"\u8bbe\u8ba1","text":""},{"location":"proposal/03-egress-ip/README_zh-CN/#crd","title":"CRD","text":""},{"location":"proposal/03-egress-ip/README_zh-CN/#egressnode","title":"EgressNode","text":"<p>\u7528\u4e8e\u8bb0\u5f55\u8de8\u8282\u70b9\u901a\u4fe1\u7684\u96a7\u9053\u7f51\u5361\u4fe1\u606f\u3002\u96c6\u7fa4\u7ea7\u8d44\u6e90\uff0c\u4e0e Kubernetes Node \u8d44\u6e90\u540d\u79f0\u4e00\u4e00\u5bf9\u5e94\u3002</p> <pre><code>apiVersion: egressgateway.spidernet.io/v1beta1\nkind: EgressNode\nmetadata:\n   name: \"node1\"\nstatus:\n   tunnel:\n      ipv4: \"192.200.222.157\"  # 1\n      ipv6: \"fd01::f2\"         # 2        \n      mac: \"66:50:85:cb:b2:bf\" # 3\n      parent:\n         name: \"ens160\"        # 4\n         ipv4: \"10.6.1.21/16\"  # 5\n         ipv6: \"fd00::21/112\"  # 6\n   phase: \"Succeeded\"          # 7\n   mark: \"0x26000000\"          # 8\n</code></pre> <ol> <li>\u96a7\u9053 IPv4 \u5730\u5740</li> <li>\u96a7\u9053 IPv6 \u5730\u5740</li> <li>\u96a7\u9053 MAC \u5730\u5740</li> <li>\u96a7\u9053\u7236\u7f51\u5361</li> <li>\u96a7\u9053\u7236\u7f51\u5361 IPv4 \u5730\u5740 </li> <li>\u96a7\u9053\u7236\u7f51\u5361 IPv6 \u5730\u5740 </li> <li>\u5f53\u524d\u96a7\u9053\u5c31\u7eea\u9636\u6bb5</li> <li>mark \u5730\u5740\uff0c\u6b64\u4e3a\u65b0\u589e\u6b64\u6bb5\uff0c\u521b\u5efa\u65f6\u751f\u6210\u3002\u6bcf\u4e2a\u8282\u70b9\u5bf9\u5e94\u4e00\u4e2a\uff0c\u5168\u5c40\u552f\u4e00\u7684\u6807\u7b7e\u3002\u6807\u7b7e\u7531\u524d\u7f00 + \u552f\u4e00\u6807\u8bc6\u7b26\u751f\u6210\u3002\u6807\u7b7e\u683c\u5f0f\u5982\u4e0b <code>NODE_MARK = 0x26 + value + 0000</code>\uff0c<code>value</code> \u4e3a 16 \u4f4d\uff0c\u652f\u6301\u7684\u8282\u70b9\u603b\u6570\u4e3a <code>2^16</code>\u3002\u5728\u4e0b\u53d1 policy \u89c4\u5219\u65f6\u6240\u6253\u7684\u6807\u7b7e\uff0c\u53d6\u51b3\u4e8e\u8be5\u89c4\u5219\u7684 EIP \u6240\u751f\u6548\u7684\u8282\u70b9\u3002</li> </ol>"},{"location":"proposal/03-egress-ip/README_zh-CN/#egressgateway","title":"EgressGateway","text":"<p>\u7528\u4e8e\u9009\u62e9\u4e00\u7ec4\u8282\u70b9\u4f5c\u4e3a Egress \u7f51\u5173\u8282\u70b9\uff0cEgress IP \u53ef\u4ee5\u5728\u8be5\u8303\u56f4\u6d6e\u52a8\u3002\u96c6\u7fa4\u7ea7\u8d44\u6e90\u3002</p> <pre><code>apiVersion: egressgateway.spidernet.io/v1beta1\nkind: EgressGateway\nmetadata:\n  name: \"eg1\"\nspec:                            # 1\n  ranges:\n   policy: \"Random\"              # 2\n   ipv4:\n   - \"\"\n   ipv6:\n   - \"\"\n  nodeSelector:                  # 3\n    selector: \n      matchLabels:\n        egress: \"true\"\n    policy: \"AverageSelecton\"    # 4\nstatus:\n  nodeList:                 # 5\n  - name: node1             # 6\n    eips:                   \n    - ipv4: \"\"              # 7\n      ipv6: \"\"\n      policies:             # 8\n      - \"\"\n</code></pre> <ol> <li>\u8bbe\u7f6e Egress IP \u7684\u8303\u56f4\uff1b</li> <li>\u652f\u6301\u8bbe\u7f6e\u5355\u4e2a IP <code>10.6.0.1</code> \uff0c\u548c\u6bb5 <code>10.6.0.1-10.6.0.10</code> \uff0c CIDR <code>10.6.0.1/26</code>  \u7684\u65b9\u5f0f 3 \u79cd\u65b9\u5f0f\uff1b</li> <li>\u5982\u679c\u5f00\u542f\u53cc\u6808\u8981\u6c42\uff0cIPv4 \u7684\u6570\u91cf\u548c IPv6 \u7684\u6570\u91cf\u65f6\u4e00\u81f4\u7684\u3002\u7531\u4e8e\u6b64\u539f\u56e0\uff0c\u4f1a\u5bfc\u81f4\u4e0a\u9762 CIDR \u53ef\u80fd\u5e76\u4e0d\u5b9e\u7528\uff0c\u56e0\u6b64\u4f18\u5148\u7ea7\u4f18\u5148\u5b9e\u73b0\u524d 2 \u79cd\uff1b</li> <li>EIP \u7684\u5206\u914d\u7b56\u7565\uff0c\u6682\u65f6\u53ea\u652f\u6301 <code>Random</code> \u968f\u673a\u5206\u914d</li> <li>\u8bbe\u7f6e EgressGateway IP \u53ef\u6d6e\u52a8\u7684\u8282\u70b9\u8303\u56f4\u53ca\u7b56\u7565\uff1b</li> <li>policy \u9009\u7f51\u5173\u8282\u70b9\u7684\u7b56\u7565\uff0c\u6682\u65f6\u53ea\u652f\u6301 <code>AverageSelecton</code> \u5e73\u5747\u5206\u914d</li> <li>Egress Gateway Controller \u7528\u4e8e\u8bb0\u5f55\u663e\u793a nodeSelector \u5339\u914d\u4e2d\u7684\u8282\u70b9\uff0c\u5bf9\u4e8e Node \u66f4\u65b0 Label \u6216 nodeSelector \u53d8\u52a8\u90fd\u4f1a\u5f15\u8d77\u6b64\u5b57\u6bb5\u53d8\u52a8\uff0cAgent \u662f\u6b64\u5b57\u6bb5\u7684\u6d88\u8d39\u8005\uff0c\u4f1a\u5c06\u5c5e\u4e8e\u81ea\u5df1\u8282\u70b9\u7684 IP \u8bbe\u7f6e\u5230\u9ed8\u8ba4\u540d\u4e3a <code>egress.eip</code> \u7f51\u5361\uff1b</li> <li>\u88ab\u5f15\u7528\u8be5 EgressGateway \u7684 EgressGatewayPolicy \u9009\u4e2d\uff0c\u4f5c\u4e3a\u7f51\u5173\u7684\u8282\u70b9\uff1b</li> <li>\u751f\u6548\u7684 EIP\uff0c\u5982\u679c EgressGatewayPolicy \u4e2d useNodeIP \u4e3a <code>true</code> \u65f6\uff0c\u5219\u8be5\u5b57\u6bb5\u4e3a\u7a7a;</li> <li>Agent \u901a\u8fc7\u8be5\u5b57\u6bb5\u5224\u65ad\u54ea\u4e9b\u8282\u70b9\u662f\u54ea\u4e9b EgressGatewayPolicy \u7684\u7f51\u5173\u8282\u70b9\u53ca\u975e\u7f51\u5173\u8282\u70b9\uff1b</li> </ol>"},{"location":"proposal/03-egress-ip/README_zh-CN/#egressgatewaypolicy","title":"EgressGatewayPolicy","text":"<p>\u7528\u4e8e\u6307\u5b9a\u54ea\u4e9b Pod \u8d70 Egress \u7b56\u7565\uff0c\u4ee5\u53ca Egress \u6240\u4f7f\u7528\u7684 IP \u5730\u5740\u3002\u79df\u6237\u7ea7\u8d44\u6e90\u3002</p> <pre><code>apiVersion: egressgateway.spidernet.io/v1beta1\nkind: EgressGatewayPolicy\nmetadata:\n  namespace: \"default\"\n  name: \"policy-test\"\nspec:\n  egressGatewayName: \"eg1\"  # 1\n  egressIP:                 # 2\n    ipv4: \"\"                            \n    ipv6: \"\"\n    useNodeIP: false        # 3\n  appliedTo:                # 4\n    podSelector:            # 4-a \n      matchLabels:    \n        app: \"shopping\"\n    podSubnet:              # 4-b\n    - \"172.29.16.0/24\"\n    - 'fd00:1/126'\n  destSubnet:               # 5\n    - \"10.6.1.92/32\"\n    - \"fd00::92/128\"\n</code></pre> <ol> <li>\u9009\u62e9\u7b56\u7565\u5f15\u7528\u7684 EgressGateway\uff1b</li> <li>Egress IP \u51c6\u5165\u7b56\u7565\uff1b</li> <li>\u82e5\u5728\u521b\u5efa\u65f6\u5b9a\u4e49\u4e86 <code>ipv4</code> \u6216 <code>ipv6</code> \u5730\u5740\uff0c\u5219\u4ece EgressGateway \u7684 <code>.ranges</code> \u4e2d\u5206\u914d\u4e00\u4e2a IP \u5730\u5740\uff0c\u82e5\u7528\u6237\u5728 policy1 \u4e2d\uff0c\u7533\u8bf7\u4f7f\u7528\u4e86 IP \u5730\u5740 <code>10.6.1.21</code> \u548c <code>fd00:1</code> \uff0c\u7136\u540e\u521b\u5efa policy2 \u4e2d\uff0c\u7533\u8bf7\u4f7f\u7528\u4e86 IP \u5730\u5740 <code>10.6.1.21</code> \u548c <code>fd00:2</code> \uff0c\u5219\u4f1a\u62a5\u9519\uff0c\u6b64\u65f6 policy2 \u4f1a\u5206\u914d\u5931\u8d25\uff1b</li> <li>\u82e5\u672a\u5b9a\u4e49 <code>ipv4</code> \u6216 <code>ipv6</code> \u5730\u5740\uff0c\u4e14 <code>useNodeIP</code> \u4e3a true \u65f6\uff0c\u5219\u4f7f\u7528\u6240\u5f15\u7528 EgressGateway \u7684\u5339\u914d\u4e2d\u7684 Node \u7684 IP \u4f5c\u4e3a Egress \u5730\u5740\u3002</li> <li>\u82e5\u672a\u5728\u521b\u5efa\u65f6\u5b9a\u4e49 <code>ipv4</code> \u6216 <code>ipv6</code> \u5730\u5740\uff0c\u4e14 <code>useNodeIP</code> \u4e3a <code>false</code> \u65f6\u3002<ul> <li>\u5219\u81ea\u52a8\u4ece EgressGateway \u7684 <code>.ranges</code> \u4e2d\u5206\u914d\u4e00\u4e2a IP \u5730\u5740\uff08\u5f00\u542f IPv6 \u65f6\uff0c\u8bf7\u6c42\u5206\u914d\u4e00\u4e2a IPv4 \u548c \u4e00\u4e2a IPv6 \u5730\u5740\uff09\uff1b</li> </ul> </li> <li>\u82e5 <code>egressGatewayName</code> \u672a\u5b9a\u4e49\uff1b<ul> <li>\u7ee7\u7eed\u5219\u67e5\u770b\u662f\u5f53\u524d Namespace \u7684 label \u952e <code>egressgateway.spidernet.io/default</code> \u662f\u5426\u8bbe\u7f6e\u9ed8\u8ba4\u7684 EgressGateway\uff0c\u5982\u679c\u6709\u4e14\u5141\u8bb8\u6b64\u79df\u6237\u4f7f\u7528\uff0c\u5219\u4ece\u6b64\u5206\u914d EgressIP\uff1b</li> <li>\u7ee7\u7eed\u67e5\u770b\u662f\u5426\u6709\u540d\u79f0\u4e3a <code>default</code> \u5168\u5c40\u9ed8\u8ba4 EgressGateway\uff0c\u5982\u679c\u6709\u4e14\u5141\u8bb8\u6b64\u79df\u6237\u4f7f\u7528\uff0c\u5219\u4ece\u6b64\u5206\u914d EgressIP\u3002</li> </ul> </li> <li>\u652f\u6301\u4f7f\u7528\u8282\u70b9 IP \u4f5c\u4e3a Egress IP\uff08\u53ea\u5141\u8bb8\u9009\u62e9\u4e00\u79cd\uff09\uff1b</li> <li>\u9009\u62e9\u9700\u8981\u5e94\u7528 Egress Gateway Policy \u7684 Pod\uff1b    a. \u4ee5 Label \u7684\u65b9\u5f0f\u8fdb\u884c\u9009\u62e9    b. \u76f4\u63a5\u6307\u5b9a Pod \u7684\u7f51\u6bb5 \uff08a \u548c b \u4e0d\u80fd\u540c\u65f6\u4f7f\u7528\uff09</li> <li>\u6307\u5b9a\u8bbf\u95ee Egress \u7684\u76ee\u6807\u5730\u5740\uff0c\u82e5\u672a\u6307\u5b9a\u76ee\u6807\u5730\u5740\uff0c\u5219\u751f\u6548\u7684\u7b56\u7565\u4f4d\u76ee\u6807\u5730\u5740\u975e\u96c6\u7fa4\u5185 CIDR \u65f6\uff0c\u5168\u90e8\u8f6c\u53d1\u5230 Egress \u8282\u70b9\u3002</li> </ol>"},{"location":"proposal/03-egress-ip/README_zh-CN/#egressendpointslice","title":"EgressEndpointSlice","text":"<p>\u805a\u5408 EgressGatewayPolicy \u5339\u914d\u4e2d\u7684\u7aef\u70b9\uff0c\u4ee5\u63d0\u9ad8\u6269\u5c55\u6027\uff0c\u4ec5\u652f\u6301 EgressGatewayPolicy \u4f7f\u7528 <code>podSelector</code> \u7684\u65b9\u5f0f\u5339\u914d Pod \u7684\u60c5\u51b5\u3002\u6bcf\u4e2a EgressEndpointSlice \u4e2d\u7684 Endpoint \u4e2a\u6570\u9ed8\u8ba4\u4e0d\u8d85\u8fc7 100\uff0c\u6700\u5927\u503c\u53ef\u4ee5\u8fdb\u884c\u8bbe\u7f6e\u3002\u662f EgressGatewayPolicy \u7684\u9644\u5c5e\u8d44\u6e90\u3002</p> <pre><code>apiVersion: egressgateway.spidernet.io/v1beta1\nkind: EgressEndpointSlice\nmetadata:\n  name: \"policy-test-dx66t\"     # 1\n  namespace: \"default\"         \n  labels:\n    egressgateway.spidernet.io/egressgatewaypolicy: \"policy-test\"  # 2\n  ownerReferences:   # 3\n  - apiVersion: egressgateway.spidernet.io/v1beta1\n    blockOwnerDeletion: true\n    controller: true\n    kind: EgressGatewayPolicy\n    name: \"policy-test\"\n    uid: 1b2ec0a8-b929-4528-8f99-499f981d319e\ndata:\n  endpoints:                   # 4\n  - podName: \"web-app\"         \n    ipv4List:\n    - \"172.29.30.123\" \n    ipv6List:\n    - \"xxx\"         \n    nodeName: \"node1\"          # 5\n    uuid: \"\"\n</code></pre> <ol> <li>\u540d\u79f0\u7531 <code>policy-name-xxxxx</code> \u7ec4\u6210\uff0c\u540e\u9762 5 \u4f4d\u968f\u673a\u751f\u6210\uff1b</li> <li>\u6240\u5c5e\u7684 EgressGatewayPolicy \u540d\u79f0\uff1b</li> <li>\u521b\u5efa\u65f6\u540c\u6b65\u8bbe\u7f6e ownerReferences\uff1b</li> <li>\u5339\u914d\u4e2d\u7684 endpoints \u7684\u5217\u8868\uff1b</li> <li>Pod \u6240\u5728\u7684\u8282\u70b9\u3002</li> </ol>"},{"location":"proposal/03-egress-ip/README_zh-CN/#_6","title":"\u6570\u636e\u9762\u89c4\u5219","text":"<p>\u5bf9\u9700\u8981\u751f\u6548\u7684\u89c4\u5219\u5206\u4e3a\u4e09\u7c7b\uff1a\u6240\u6709\u8282\u70b9\uff0c\u76f8\u5bf9\u4e8e EgressGatewayPolicy \u7684\u300c\u7f51\u5173\u8282\u70b9\u300d\u548c\u300c\u975e\u7f51\u5173\u8282\u70b9\u300d\u3002</p>"},{"location":"proposal/03-egress-ip/README_zh-CN/#_7","title":"\u6240\u6709\u8282\u70b9","text":"<ol> <li>\u5404\u8282\u70b9\u4e4b\u95f4\uff0c\u96a7\u9053\u9700\u8981\u6253\u901a\u7684\u89c4\u5219\u5c31\u5c31\u4e0d\u4e00\u4e00\u5c55\u5f00\uff1b</li> <li>\u5c06 policy \u547d\u4e2d\u7684\u6d41\u91cf\uff0c\u91cd\u65b0\u6253\u6807\u7b7e\u3002\u8282\u70b9\u7b2c\u4e00\u6b21\u53d8\u6210\u7f51\u5173\u8282\u70b9\u65f6\u66f4\u65b0\uff0c\u6216\u8005\u8282\u70b9 join \u65f6\u505a\u4e00\u6b21\uff0c\u540e\u9762\u4e0d\u66f4\u65b0\uff1b    ```shell    iptables -t mangle -N EGRESSGATEWAY-RESET-MARK    iptables -t mangle -I FORWARD 1  -j EGRESSGATEWAY-RESET-MARK -m comment --comment \"egress gateway: mark egress packet\"</li> </ol> <p>iptables -t mangle -A EGRESSGATEWAY-RESET-MARK \\        -m mark --mark $NODE_MARK/0x26000000 \\        -j MARK --set-mark 0x12000000 \\        -m comment --comment \"egress gateway: change mark\"    <code>3. \u4fdd\u6301 policy \u547d\u4e2d\u6d41\u91cf\u7684\u6807\u7b7e\u3002\u76f4\u63a5\u521b\u5efa\u4e00\u6b21\uff0c\u4e0d\u9700\u8981\u66f4\u65b0\uff1b</code>shell    iptables -t filter -I FORWARD 1 -m mark --mark 0x12000000 -j ACCEPT -m comment --comment \"egress gateway: keep mark\"    iptables -t filter -I OUTPUT 1 -m mark --mark 0x12000000 -j ACCEPT -m comment --comment \"egress gateway: keep mark\"    iptables -t mangle -I POSTROUTING 1 -m mark --mark 0x12000000 -j ACCEPT -m comment --comment \"egress gateway: keep mark\"    <code>4. policy \u547d\u4e2d\u7684\u6e90 IP\u3001\u76ee\u7684 IP \u7684 ipset\uff1b</code>shell    IPSET_RULE_DEST_NAME=egress-dest-uuid    ipset x $IPSET_RULE_DEST_NAME    ipset create $IPSET_RULE_DEST_NAME hash:net    ipset add $IPSET_RULE_DEST_NAME 10.6.105.150/32</p> <p>IPSET_RULE_SRC_NAME=egress-src-uuid    ipset x $IPSET_RULE_SRC_NAME    ipset create $IPSET_RULE_SRC_NAME hash:net    ipset add $IPSET_RULE_SRC_NAME 172.29.234.173/32    <code>5. \u805a\u5408 policy \u547d\u4e2d\u6d41\u91cf\u6253\u6807\u7b7e\u7684\u94fe\u3002\u76f4\u63a5\u521b\u5efa\u4e00\u6b21\uff0c\u4e0d\u9700\u8981\u66f4\u65b0\uff1b</code>shell    iptables -t mangle -N EGRESSGATEWAY-MARK-REQUEST    iptables -t mangle -I PREROUTING 1 -j EGRESSGATEWAY-MARK-REQUEST -m comment --comment \"egress gateway: mark egress packet\"    <code>6. \u805a\u5408\u4e0d\u9700\u8981\u505a SNAT \u89c4\u5219\u7684\u94fe\u3002\u76f4\u63a5\u521b\u5efa\u4e00\u6b21\uff0c\u4e0d\u9700\u8981\u66f4\u65b0\uff1b</code>shell    iptables -t nat -N EGRESSGATEWAY-NO-SNAT    iptables -t nat -I POSTROUTING 1  -j EGRESSGATEWAY-NO-SNAT -m comment --comment \"egress gateway: no snat\"</p> <p>iptables -t nat -A EGRESSGATEWAY-NO-SNAT -m mark --mark 0x12000000 -j ACCEPT -m comment --comment \"egress gateway: no snat\"    <code>7. \u805a\u5408\u9700\u8981\u505a SNAT \u89c4\u5219\u7684\u94fe\u3002\u76f4\u63a5\u521b\u5efa\u4e00\u6b21\uff0c\u4e0d\u9700\u8981\u66f4\u65b0\u3002</code>shell    iptables -t nat -N EGRESSGATEWAY-SNAT-EIP    # \u9700\u8981\u5728\u4e0d\u9700\u8981 SNAT \u7684\u89c4\u5219\u540e\u9762\u63d2\u5165\uff0c\u624d\u80fd\u4fdd\u8bc1\u8be5\u94fe\u5728\u6700\u524d\u9762    iptables -t nat -I POSTROUTING 1  -j EGRESSGATEWAY-SNAT-EIP -m comment --comment \"egress gateway: snat EIP\"    ```</p>"},{"location":"proposal/03-egress-ip/README_zh-CN/#eip-egress-gateway","title":"\u76f8\u5bf9\u4e8e EIP \u7684\u975e Egress Gateway \u8282\u70b9","text":"<ol> <li>policy \u547d\u4e2d\u7684\u6d41\u91cf\u6253\u6807\u7b7e\uff0c\u4fdd\u8bc1\u80fd\u4ece\u96a7\u9053\u8d70\u3002\u5176\u4e2d NODE_MARK \u7684\u503c\u6839\u636e policy \u5bf9\u5e94\u7684 EIP \u6240\u5728\u8282\u70b9\u51b3\u5b9a\u3002    <code>shell    iptables -A EGRESSGATEWAY-MARK-REQUEST -t mangle -m conntrack --ctdir ORIGINAL \\    -m set --match-set $IPSET_RULE_DEST_NAME dst  \\    -m set --match-set $IPSET_RULE_SRC_NAME src  \\    -j MARK --set-mark $NODE_MARK -m comment --comment \"rule uuid: mark request packet\"</code></li> <li>\u7b56\u7565\u8def\u7531\u89c4\u5219    <code>shell    ip rule add fwmark $NODE_MARK table $TABLE_NUM</code> 3.\u9002\u914d Weave \u907f\u514d\u505a SNAT \u6210 Egress \u96a7\u9053\u7684 IP\u3002\u505a\u6210\u5f00\u5173    <code>shell    iptables -t nat -A EGRESSGATEWAY-NO-SNAT \\    -m set --match-set $IPSET_RULE_DEST_NAME dst  \\    -m set --match-set $IPSET_RULE_SRC_NAME src  \\    -j ACCEPT -m comment --comment \"egress gateway: weave does not do SNAT\"</code></li> </ol>"},{"location":"proposal/03-egress-ip/README_zh-CN/#eip-egress-gateway_1","title":"\u76f8\u5bf9\u4e8e EIP \u7684 Egress Gateway \u8282\u70b9","text":"<ol> <li>policy \u547d\u4e2d\u7684\u6d41\u91cf\u3002\u51fa\u7f51\u5173\u65f6\u505a SNAT\u3002\u5b9e\u65f6\u66f4\u65b0\u3002    <code>shell    iptables -t nat -A EGRESSGATEWAY-SNAT-EIP \\        -m set --match-set $IPSET_RULE_SRC_NAME src \\        -m set --match-set $IPSET_RULE_DST_NAME dst \\        -j SNAT --to-source $EIP</code></li> </ol>"},{"location":"proposal/03-egress-ip/README_zh-CN/#egressgatewaypolicy-eip","title":"EgressGatewayPolicy \u9009\u7f51\u5173\u8282\u70b9\u53ca EIP \u5206\u914d\u903b\u8f91","text":"<p>\u4e00\u4e2a policy \u4f1a\u6839\u636e\u9009\u7f51\u5173\u8282\u70b9\u7684\u7b56\u7565\uff0c\u9009\u62e9\u4e00\u4e2a\u8282\u70b9\u4f5c\u4e3a\u7f51\u5173\u8282\u70b9\u3002\u7136\u540e\u6839\u636e\u662f\u5426\u4f7f\u7528 EIP\uff0c\u6765\u51b3\u5b9a\u662f\u5426\u5206\u914d EIP\u3002\u5206\u914d\u7684 EIP \u5c06\u7ed1\u5b9a\u5230\u6240\u9009\u7684\u7f51\u5173\u8282\u70b9\u4e0a</p> <p>\u5206\u914d\u903b\u8f91\u90fd\u662f\u4ee5\u5355\u4e2a EgressGateway \u4e3a\u5bf9\u8c61\uff0c\u800c\u4e0d\u662f\u6240\u6709\u7684 EgressGateway\u3002</p>"},{"location":"proposal/03-egress-ip/README_zh-CN/#policy","title":"policy \u9009\u7f51\u5173\u8282\u70b9\u7684\u6a21\u5f0f","text":"<ul> <li>\u5e73\u5747\u9009\u62e9\uff1a\u5f53\u9700\u8981\u9009\u62e9\u7f51\u5173\u8282\u70b9\u65f6\uff0c\u9009\u62e9\u4f5c\u4e3a\u7f51\u5173\u8282\u70b9\u6700\u5c11\u7684\u4e00\u4e2a\u8282\u70b9\u3002</li> <li>\u6700\u5c11\u8282\u70b9\u9009\u62e9\uff1a\u5c3d\u91cf\u9009\u540c\u4e00\u4e2a\u8282\u70b9\u4f5c\u4e3a\u7f51\u5173\u8282\u70b9</li> <li>\u9650\u5ea6\u9009\u62e9\uff1a\u4e00\u4e2a\u8282\u70b9\u6700\u591a\u53ea\u80fd\u6210\u4e3a\u51e0\u4e2a policy \u7684\u7f51\u5173\u8282\u70b9\uff0c\u9650\u5ea6\u53ef\u4ee5\u8bbe\u7f6e\uff0c\u9ed8\u8ba4\u4e3a 5\u3002\u6ca1\u6709\u8fbe\u5230\u9650\u5ea6\u524d\uff0c\u5219\u4f18\u5148\u9009\u62e9\u8be5\u8282\u70b9\uff0c\u8fbe\u5230\u9650\u5ea6\u5c31\u9009\u5176\u4ed6\u7684\u8282\u70b9\uff0c\u5982\u679c\u90fd\u8fbe\u5230\u4e86\u9650\u5ea6\uff0c\u5219\u968f\u673a\u9009\u62e9</li> </ul>"},{"location":"proposal/03-egress-ip/README_zh-CN/#eip","title":"EIP \u5206\u914d\u903b\u8f91","text":"<ul> <li>\u968f\u673a\u5206\u914d\uff1a\u5728\u6240\u6709\u7684 EIP \u4e2d\u968f\u673a\u9009\u62e9\u4e00\u4e2a\uff0c\u4e0d\u7ba1\u8be5 EIP \u662f\u5426\u5df2\u7ecf\u5206\u914d</li> <li>\u4f18\u5148\u4f7f\u7528\u672a\u5206\u914d\u7684 EIP\uff1a\u5148\u4f7f\u7528\u672a\u5206\u914d\u7684 EIP\uff0c\u5982\u679c\u90fd\u4f7f\u7528\u4e86\u5219\u518d\u968f\u673a\u5206\u914d\u4e00\u4e2a\u5df2\u4f7f\u7528\u7684 EIP</li> <li>\u9650\u5ea6\u9009\u62e9\uff1a\u4e00\u4e2a EIP \u6700\u591a\u53ea\u80fd\u88ab\u51e0\u4e2a policy \u4f7f\u7528\uff0c\u9650\u5ea6\u53ef\u4ee5\u8bbe\u7f6e\uff0c\u9ed8\u8ba4\u4e3a 5\uff0c\u6ca1\u6709\u8fbe\u5230\u9650\u5ea6\u524d\uff0c\u5219\u5148\u5206\u914d\u8be5 EIP\uff0c\u8fbe\u5230\u9650\u5ea6\u5219\u9009\u5176\u4ed6\u7684 EIP\u3002\u90fd\u8fbe\u5230\u9650\u5ea6\u5219\u968f\u673a\u5206\u914d\u3002</li> </ul>"},{"location":"proposal/03-egress-ip/README_zh-CN/#eip_1","title":"EIP \u56de\u6536\u903b\u8f91","text":"<p>\u5f53\u4e00\u4e2a EIP \u6ca1\u6709\u88ab policy \u4f7f\u7528\u65f6\uff0c\u5219\u56de\u6536\u8be5 EIP\uff0c\u56de\u6536\u5c31\u662f\u5728 eips \u4e2d\u5c06\u8be5 EIP \u5b57\u6bb5\u5220\u9664</p>"},{"location":"proposal/03-egress-ip/README_zh-CN/#_8","title":"\u5176\u4ed6","text":"<ol> <li>dummy \u7f51\u5361\u53ca EIP\uff1a\u6bcf\u4e2a\u8282\u70b9\u53ea\u6709\u4e00\u4e2a\u540d\u4e3a <code>egress.eip</code> \u7684 dummy \u7f51\u5361\uff0c\u6240\u6709\u7684 EIP \u90fd\u751f\u6548\u5728\u8be5\u8282\u70b9\u4e0a    ```shell    # \u521b\u5efa dummy \u7f51\u5361    ip link add egress.eip type dummy    ip link set egress.eip up</li> </ol> <p># \u8bbe\u7f6e EIP    ip addr add 10.6.168.100 dev egress.eip    ```</p> <ol> <li>\u7531\u4e8e EIP \u662f\u751f\u6548\u5728 dummy \u7f51\u5361\u4e0a\u7684\uff0c\u6240\u4ee5\u9700\u8981\u914d\u7f6e ARP \u4ee3\u7b54\u3002    ```shell    sysctl -w net.ipv4.conf.all.arp_ignore=0</li> </ol> <p># \u6240\u6709\u7684\u7269\u7406\u7f51\u5361\u90fd\u9700\u8981\u8bbe\u7f6e\u4ee3\u7b54\uff0c\u4e0d\u786e\u5b9a\u4ece\u90a3\u79cd\u7f51\u5361\u51fa\u53bb    sysctl -w net.ipv4.conf.xxx.arp_ignore=0    ```</p> <ol> <li> <p>mangle-FORWARD match \u91cd\u65b0\u6253\u6807\u7b7e\uff0c\u56e0\u4e3a <code>NODE_MARK = 0x26 + value + 0000</code>\uff0c\u6240\u4ee5\u5339\u914d\u65f6\u53ea\u8981\u5339\u914d\u524d\u976216 \u4f4d\u3002    <code>shell    iptables -t mangle -I FORWARD 1 -m mark --mark 0x26000000/0x26000000 -j MARK --set-mark 0x12000000 -m comment --comment \"egress gateway: change mark\"</code></p> </li> <li> <p>\u66f4\u65b0 ipset \u5185\u5bb9\uff0cCRD \u4e2d\u805a\u5408\u4e86\u6700\u65b0\u7684 IP \u5185\u5bb9\uff0c\u53ef\u4ee5\u5148\u521b\u5efa\u4e34\u65f6 ipset \u518d\u901a\u8fc7 swap \u8fdb\u884c\u4ea4\u6362\uff0c\u5927\u91cf\u7b80\u5316 ipset \u64cd\u4f5c\uff0c\u63d0\u9ad8\u6548\u7387\u3002    <code>shell    ipset create egress-dst-v4-xxx-tmp     ipset add egress-dst-v4-xxx-tmp $NEW_IP_RANGE    ipset swap egress-dst-v4-xxx egress-dst-v4-xxx-tmp</code></p> </li> </ol>"},{"location":"proposal/03-egress-ip/README_zh-CN/#_9","title":"\u4ee3\u7801\u8bbe\u8ba1","text":""},{"location":"proposal/04-auto-detect-egress-ignore-cidr/README_zh-CN/","title":"Egress ignore CIDR","text":""},{"location":"proposal/04-auto-detect-egress-ignore-cidr/README_zh-CN/#_1","title":"\u52a8\u673a","text":"<p>\u4e3a\u4e86\u7b80\u5316 Egress \u7b56\u7565\u7684\u914d\u7f6e\uff0c\u5f15\u5165 Egress Ignore CIDR \u529f\u80fd\uff0c\u5141\u8bb8\u4ee5\u624b\u52a8\u548c\u81ea\u52a8\u7684\u65b9\u5f0f\u83b7\u53d6\u96c6\u7fa4\u7684 CIDR\u3002\u5f53 EgressGatewayPolicy \u7684 <code>destSubnet</code> \u5b57\u6bb5\u4e3a\u7a7a\u65f6\uff0c\u6570\u636e\u9762\u5c06\u4f1a\u81ea\u52a8\u5339\u914d EgressClusterStatus CR \u4e2d\u7684 CIDR \u4e4b\u5916\u7684\u6d41\u91cf\uff0c\u5e76\u5c06\u5176\u8f6c\u53d1\u5230 Egress \u7f51\u5173\u3002</p>"},{"location":"proposal/04-auto-detect-egress-ignore-cidr/README_zh-CN/#_2","title":"\u76ee\u6807","text":"<ul> <li>\u4f18\u5316 EgressGatewayPolicy \u4f7f\u7528\u4f53\u9a8c</li> </ul>"},{"location":"proposal/04-auto-detect-egress-ignore-cidr/README_zh-CN/#_3","title":"\u8bbe\u8ba1","text":""},{"location":"proposal/04-auto-detect-egress-ignore-cidr/README_zh-CN/#_4","title":"\u914d\u7f6e\u6587\u4ef6","text":"<p>\u4fee\u6539\u914d\u7f6e\u6587\u4ef6\uff0c\u589e\u52a0\u5982\u4e0b\u914d\u7f6e\uff1a</p> <pre><code>feature:\n  egressIgnoreCIDR:\n    autoDetect:\n      podCIDR: \"\"     # 1\n      clusterIP: true # 2\n      nodeIP: true    # 3\n    custom:\n      - \"10.6.1.0/24\"\n</code></pre> <ol> <li>\u652f\u6301\u8bbe\u7f6e\u4e3a\u652f\u6301 kube-ovn, calico, k8s \u7b49\uff1b</li> <li>\u652f\u6301\u8bbe\u7f6e\u4e3a Service CIDR \u81ea\u52a8\u68c0\u6d4b\uff1b</li> <li>\u652f\u6301\u8bbe\u7f6e\u4e3a Node IP \u81ea\u52a8\u68c0\u6d4b\uff0c\u5f53\u65b0\u52a0\u4e00\u4e2a\u8282\u70b9\u65f6\uff0c\u81ea\u52a8\u5c06\u8282\u70b9\u7684\u7684\u6240\u6709 IP \u66f4\u65b0\u5230 EgressClusterStatus\u3002</li> </ol>"},{"location":"proposal/04-auto-detect-egress-ignore-cidr/README_zh-CN/#egressclusterstatus-crd","title":"EgressClusterStatus CRD","text":"<p>\u96c6\u7fa4\u7ea7 CRD\u3002</p> <pre><code>apiVersion: egressgateway.spidernet.io/v1beta1\nkind: EgressClusterStatus\nmetadata:\n   name: \"default\"  # 1\nstatus:\n  egressIgnoreCIDR:\n    nodeIP:\n      ipv4:\n      - \"10.6.0.1\"\n      ipv6:\n      - \"fd00::1\"\n    clusterIP:\n      ipv4:\n      - \"10.6.0.1\"\n      ipv6:\n      - \"fd00::1\"\n    podCIDR:\n      ipv4:\n      - \"10.6.0.0/24\"\n      ipv6:\n      - \"fd00::1/122\"\n</code></pre> <ol> <li>\u540d\u79f0\u4e3a <code>default</code>\uff0c\u7531\u7cfb\u7edf\u7ef4\u62a4\u53ea\u80fd\u521b\u5efa\u4e00\u4e2a;</li> <li>\u6839\u636e <code>egressIgnoreCIDR.autoDetect</code> \u914d\u7f6e\u68c0\u6d4b\u51fa\u7684\u96c6\u7fa4 CIDR \u6216 IP\u3002</li> </ol>"},{"location":"proposal/04-auto-detect-egress-ignore-cidr/README_zh-CN/#_5","title":"\u6570\u636e\u9762\u7b56\u7565","text":""},{"location":"proposal/04-auto-detect-egress-ignore-cidr/README_zh-CN/#ipset","title":"ipset","text":"<p>\u6570\u636e\u9762\u5728\u5904\u7406 <code>destSubnet</code> \u4e3a\u7a7a\u7684\u7684 EgressGatewayPolicy \u65f6\uff0c\u5c06 iptables \u5339\u914d\u7b56\u7565\u6539\u4e3a <code>--match-set !egress-ingore-cidr dst</code>\u3002</p> <pre><code>iptables -A EGRESSGATEWAY-MARK-REQUEST -t mangle -m conntrack --ctdir ORIGINAL \\\n-m set --match-set !egress-ingore-cidr dst  \\\n-m set --match-set $IPSET_RULE_SRC_NAME src  \\\n-j MARK --set-mark $NODE_MARK -m comment --comment \"rule uuid: mark request packet\"\n</code></pre>"},{"location":"proposal/04-auto-detect-egress-ignore-cidr/README_zh-CN/#_6","title":"\u4ee3\u7801\u8bbe\u8ba1","text":""},{"location":"proposal/04-auto-detect-egress-ignore-cidr/README_zh-CN/#controller","title":"Controller","text":"<p>\u65b0\u589e\u4e00\u4e2a\u63a7\u5236\u5faa\u73af\uff0c\u6839\u636e <code>egressIgnoreCIDR.autoDetect</code> \u914d\u7f6e\u6765 Watch \u96c6\u7fa4\u7684\u76f8\u5173\u8d44\u6e90\uff0c\u66f4\u65b0\u81ea\u52a8\u68c0\u6d4b\u7684 CIDR \u5230 EgressClusterStatus CR \u7684 <code>status.egressIgnoreCIDR</code> \u4e2d\u3002</p>"},{"location":"proposal/04-auto-detect-egress-ignore-cidr/README_zh-CN/#agent","title":"Agent","text":"<ul> <li>\u5728 Policy \u7684\u63a7\u5236\u5faa\u73af\u4e2d\uff0c\u5904\u7406 EgressClusterStatus \u66f4\u65b0\u5230\u540d\u4e3a <code>egress-ingore-cidr</code> \u7684 ipset \u4e2d\uff1b</li> <li>\u5bf9\u4e8e <code>destSubnet</code> \u5b57\u6bb5\u4e3a\u7a7a\u65f6\u7684 EgressGatewayPolicy \u7b56\u7565\uff0c\u4f7f\u7528 <code>egress-ingore-cidr</code> \u7684 ipset \u5339\u914d\u6d41\u91cf\u3002</li> </ul>"},{"location":"proposal/05-egress-gateway-policy-cluster/README_zh-CN/","title":"EgressGatewayPolicyCluster","text":""},{"location":"proposal/05-egress-gateway-policy-cluster/README_zh-CN/#_1","title":"\u52a8\u673a","text":"<p>\u8865\u5145\u6ca1\u6709\u96c6\u7fa4\u7ea7\u522b policy \u7684\u529f\u80fd</p>"},{"location":"proposal/05-egress-gateway-policy-cluster/README_zh-CN/#_2","title":"\u76ee\u6807","text":"<ul> <li>\u652f\u6301\u96c6\u7fa4\u7ea7\u522b\u7684 policy</li> <li>\u652f\u6301\u4f18\u5148\u7ea7</li> </ul>"},{"location":"proposal/05-egress-gateway-policy-cluster/README_zh-CN/#_3","title":"\u8bbe\u8ba1","text":"<ul> <li>\u96c6\u7fa4\u7ea7\u522b\u7684 policy\uff0c\u591a\u4e86 <code>namespaceSelector</code> \u5b57\u6bb5\u3002\u4e3a\u7a7a\u65f6\uff0c\u5219\u4f5c\u7528\u4e8e\u6574\u4e2a\u96c6\u7fa4\u3002\u4e0d\u4e3a\u7a7a\u65f6\uff0c\u5219\u4f5c\u7528\u4e8e\u7b26\u5408\u6761\u4ef6\u7684 NS\u3002</li> <li>\u7531\u4e8e\u65b0\u589e\u4e86\u96c6\u7fa4\u7ea7\u522b\u7684 policy\uff0c\u5f53\u96c6\u7fa4\u7ea7\u522b\u4e0e namespace \u7ea7\u522b\u7684\u4e24\u4e2a policy\uff0c <code>appliedTo</code>\u3001<code>destSubnet</code> \u4e00\u81f4\uff0c\u4f46 <code>egressGatewayName</code>  \u6216<code>egressIP</code> \u4e0d\u4e00\u81f4\u65f6\uff0c\u4e24\u4e2a\u7b56\u7565\u8c01\u6700\u7ec8\u751f\u6548\u5c31\u5c06\u6210\u4e3a\u4e00\u4e2a\u95ee\u9898\u3002\u6240\u4ee5\u5f15\u5165\u4e00\u4e2a\u4f18\u5148\u7ea7\u7684\u65b0\u5b57\u6bb5 <code>priority</code> \u6765\u89e3\u51b3\u8be5\u95ee\u9898\u3002\u8303\u56f4\u4e3a 1-65536\uff0c\u6570\u503c\u8d8a\u5c0f\uff0c\u4f18\u5148\u7ea7\u8d8a\u9ad8\u3002\u7528\u6237\u53ef\u4ee5\u81ea\u884c\u8bbe\u7f6e\u4f18\u5148\u7ea7\u3002\u5982\u679c\u6ca1\u8bbe\u7f6e\u65f6\uff0cEgressGatewayPolicy \u9ed8\u8ba4\u4f18\u5148\u7ea7\u4e3a 1000\uff0cEgressGatewayPolicyCluster \u9ed8\u8ba4\u4f18\u5148\u7ea7\u4e3a 32768.\u5982\u679c\u4f18\u5148\u7ea7\u4e00\u81f4\u65f6\uff0c\u5219\u968f\u673a\u6392\u5e8f\u3002</li> </ul>"},{"location":"proposal/05-egress-gateway-policy-cluster/README_zh-CN/#egressgatewaypolicy-crd","title":"EgressGatewayPolicy CRD","text":"<pre><code>apiVersion: egressgateway.spidernet.io/v1beta1\nkind: EgressGatewayPolicy\nmetadata:\n  namespace: \"default\"\n  name: \"policy-test\"\nspec:\n  priority: 100             # 1\n  egressGatewayName: \"eg1\"\n  egressIP:\n    ipv4: \"\"                            \n    ipv6: \"\"\n    useNodeIP: false\n  appliedTo:\n    podSelector:\n      matchLabels:    \n        app: \"shopping\"\n    podSubnet:\n    - \"172.29.16.0/24\"\n    - 'fd00:1/126'\n  destSubnet:\n    - \"10.6.1.92/32\"\n    - \"fd00::92/128\"\n</code></pre> <ol> <li>\u65b0\u589e\u5b57\u6bb5\uff0c\u7b56\u7565\u7684\u4f18\u5148\u7ea7</li> </ol>"},{"location":"proposal/05-egress-gateway-policy-cluster/README_zh-CN/#egressgatewaypolicycluster-crd","title":"EgressGatewayPolicyCluster CRD","text":"<pre><code>apiVersion: egressgateway.spidernet.io/v1beta1\nkind: EgressGatewayPolicyCluster\nmetadata:\n  namespace: \"default\"\n  name: \"policy-test\"\nspec:\n  priority: 100             # 1\n  egressGatewayName: \"eg1\"\n  egressIP:\n    ipv4: \"\"                            \n    ipv6: \"\"\n    useNodeIP: false\n  appliedTo:\n    podSelector:\n      matchLabels:    \n        app: \"shopping\"\n    podSubnet:\n    - \"172.29.16.0/24\"\n    - 'fd00:1/126'\n    namespaceSelector:      # 1\n      matchLabels:    \n        app: \"shopping\"\n  destSubnet:\n    - \"10.6.1.92/32\"\n    - \"fd00::92/128\"\n</code></pre> <ol> <li>\u7b56\u7565\u7684\u4f18\u5148\u7ea7</li> <li>namespace \u7b5b\u9009\u5668</li> </ol> <p>\u5176\u4ed6\u65b9\u9762\uff0c\u4e24\u8005\u4e00\u81f4</p>"},{"location":"usage/Install/","title":"Install","text":""},{"location":"usage/Install/#requirement","title":"Requirement","text":"<p>Egressgateway currently supports collaboration with Calico CNI and will support collaboration with more CNIs in the future.  Below are the configuration methods for different CNIs:</p>"},{"location":"usage/Install/#calico","title":"Calico","text":"<p>Required settings <code>chainInsertMode</code> to <code>Append</code>, for example in the code,  more reference calico docs:</p> <pre><code>apiVersion: projectcalico.org/v3\nkind: FelixConfiguration\nmetadata:\n  name: default\nspec:\n  ipv6Support: false\n  ipipMTU: 1400\n  chainInsertMode: Append # this line\n</code></pre>"},{"location":"usage/Install/#install_1","title":"Install","text":""},{"location":"usage/Install/#add-helm-repository","title":"Add helm repository","text":"<pre><code>helm repo add egressgateway https://spidernet-io.github.io/egressgateway/\nhelm repo update\n</code></pre>"},{"location":"usage/Install/#install-egressgateway","title":"Install egressgateway","text":"<p>The following is a common chart setting option:</p> <pre><code>feature:\n  enableIPv4: true\n  enableIPv6: false # Required pod support IPv6 Stack\n  tunnelIpv4Subnet: \"192.200.0.1/16\" # IPv4 tunnel subnet\n  tunnelIpv6Subnet: \"fd01::21/112\"   # IPv6 tunnel subnet\n  forwardMethod: \"active-active\"     # Support active-active or active-passive\n</code></pre> <pre><code>helm install egressgateway egressgateway/egressgateway --values values.yaml --wait --debug\n</code></pre> <pre><code>kubectl get crd | grep egress\n</code></pre>"},{"location":"usage/Install/#create-egressgateway","title":"Create EgressGateway","text":"<p>Create an EgressGateway CR that can set a node as an egress gateway node through matchLabels.</p> <pre><code>apiVersion: egressgateway.spidernet.io/v1\nkind: EgressGateway\nmetadata:\n  name: default\nspec:\n  nodeSelector:\n    matchLabels:\n      kubernetes.io/hostname: workstation2 # change me, select a node in your cluster\n</code></pre>"},{"location":"usage/Install/#create-example-app","title":"Create Example App","text":"<p>Create a testing Pod to simulate an application that requires egress.</p> <pre><code>apiVersion: v1\nkind: Pod\nmetadata:\n  labels:\n    app: mock-app\n  name: mock-app\n  namespace: default\nspec:\n  containers:\n      image: nginx\n      imagePullPolicy: IfNotPresent\n      name: nginx\n      resources: {}\n  dnsPolicy: ClusterFirst\n  enableServiceLinks: true\n  nodeName: workstation1 # change me, select a non-egress gateway node in your cluster\n</code></pre>"},{"location":"usage/Install/#create-egressgatewaypolicy","title":"Create EgressGatewayPolicy","text":"<p>By creating an EgressGatewayPolicy CR, you can control which Pod accesses which address needs to go through the egress gateway.</p> <pre><code>apiVersion: egressgateway.spidernet.io/v1\nkind: EgressGatewayPolicy\nmetadata:\n  name: mock-app\nspec:\n  appliedTo:\n    podSelector:\n      matchLabels:\n        app: mock-app\n  destSubnet:\n    - 10.6.1.92/32\n</code></pre> <p>Now traffic from mock-app accessing 10.6.1.92 will be forwarded by the egress gateway.</p>"}]}