<!--
# E2E Cases for EgressPolicy
- all case about check the `eip` will including tcp, udp and web socket

| Case ID | Title                                                                                                                                                                                                                                                                                                                                                                       | Priority | Smoke | Status | Other |
|---------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|----------|-------|--------|-------|
| P00001  | Creating an EgressPolicy fails when an illegal `EgressIP` is used                                                                                                                                                                                                                                                                                                           | p2       | false |        |       |
| P00002  | When `EgressGatewayName` is empty, when creating a cluster-level `EgressPolicy`, the default `EgressGatewa` of the cluster will be used, and the status of `EgressPolicySpec.EgressGatewayName` and `EgressPolicyStatus` is correct                                                                                                                                         | p2       | false |        |       |
| P00003  | When `EgressGatewayName` is empty, when creating a namespace-level `EgressPolicy`, <br/> if there is an annotation related to `EgressGateway` in the annotation of the corresponding namespace, use the `EgressGatewa` marked, if not, use the default `EgressGatewa` of the cluster, check` EgressPolicySpec.EgressGatewayName` and `EgressPolicyStatus` status is correct | p2       | false |        |       |
| P00004  | Creating an EgressPolicy fails when the `EgressIP` is not in the `Ippools` range of the `egressGateway` selected by the `Policy`                                                                                                                                                                                                                                            | p2       | false |        |       |
| P00005  | Creating an EgressPolicy fails when `AppliedTo` is empty                                                                                                                                                                                                                                                                                                                    | p2       | false |        |       |
| P00006  | Creating an EgressPolicy fails when both `AppliedTo.PodSubnet` and `AppliedTo.PodSelector` are set                                                                                                                                                                                                                                                                          | p2       | false |        |       |
| P00007  | When only `AppliedTo.PodSubnet` is set, the egress IP of `Pod` matched with it should be `eip`, and the egress IP of `Pod` not matched should be non-`eip`, and `endpointSlice` is not will be created                                                                                                                                                                      | p1       | true  |        |       |
| P00008  | When `EgressIP` is empty, both `EgressPolicyStatus.Eip` of `Policy` and the egress IP of the Pod is `defaultEIP` of `egressGateway`, `EgressGatewayStatus` is updated as expected                                                                                                                                                                                           | p1       | true  |        |       |
| P00009  | When the IP of `EgressIP` is empty and `EgressIP.AllocatorPolicy` is in `rr` mode, `eip` will be obtained from the IP of `EgressGatewaySpec.Ippools`, and the status of `EgressPolicyStatus` and `EgressGatewayStatus` is correct                                                                                                                                           | p2       | false |        |       |
| P00010  | When the IP of `EgressIP` is not empty and `EgressIP.AllocatorPolicy` is in `rr` mode, `EgressIP` will take effect, check `EgressPolicyStatus` and `EgressGatewayStatus` are correct                                                                                                                                                                                        | p2       | false |        |       |
| P00011  | When the `DestSubnet` of `Policy` is empty and the destination IP of the access is not within the range of the IP list in `egressClusterInfo.Status`,<br/>Pod’s egress IP is `eip`                                                                                                                                                                                          | p1       | true  |        |       |
| P00012  | When the `DestSubnet` of `Policy` is empty and the destination IP of the access is within the IP list range in `egressClusterInfo.Status`,<br/>Pod’s egress IP is not `eip`                                                                                                                                                                                                 | p1       | true  |        |       |
| P00013  | Set `DestSubnet` and `PodSelector`, when accessing the external IP that matches `DestSubnet`, the Pod’s egress IP is `eip`,<br/>When accessing the external IP that does not match `DestSubnet`, the Pod’s egress IP is not `eip`                                                                                                                                           | p1       | true  |        |       |
| P00014  | Edit `PodSelector` that originally matched `DaemonSet-A` to change it to match `DaemonSet-B`,<br/> `EgressEndpoint` will be updated from `DaemonSet-A` to `DaemonSet-B`,<br/>And the export IP of all Pods in `DaemonSet-A` is changed from `eip` to non-`eip`, and the export IP of all Pods in `DaemonSet-B` is changed from non-`eip` to `eip`                           | p1       | true  |        |       |
| P00015  | When `EgressIP.UseNodeIP` is `false` and `EgressIP` IP is empty, create `EgressPolicy`, <br/>`EgressPolicyStatus.Eip` and `EgressGatewayStatus.Eips` IP should be empty, and the pod’s egress IP is the IP of the node matched by egressGateway `nodeSelector`                                                                                                              | p1       | true  |        |       |
| P00016  | Creating an `EgressPolicy` fails when `EgressIP.UseNodeIP` is `false` and the IP of `EgressIP` is not empty                                                                                                                                                                                                                                                                 | p2       | false |        |       |
| P00017  | Failed to edite the IP of `EgressIP` of Policy                                                                                                                                                                                                                                                                                                                              | p2       | false |        |       |
| P00018  | Failed to edite the IP of `EgressGatewayName` of Policy                                                                                                                                                                                                                                                                                                                     | p2       | false |        |       |
| P00019  | `EgressGatewayStatus` and `EgressEndpoint` will update as expected after delete the policy, and the Pod's egress IP will change from `eip` to non-`eip`                                                                                                                                                                                                                     | p1       | true  |        |       |
| P00020  | `namespace-level` policy only takes effect in the namespace it specifies                                                                                                                                                                                                                                                                                                    | p2       | false |        |       |
-->
# EgressPolicy E2E 用例

- 用例中，所有有关 `eip` 校验的内容，都包含了 tcp，udp 和 web socket

| 用例编号   | 标题                                                                                                                                                                                                                            | 优先级 | 冒烟    | 状态  | 其他  |
|--------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----|-------|-----|-----|
| P00001 | 当使用不合法的 `EgressIP`，创建 EgressPolicy 失败                                                                                                                                                                                         | p2  | false |     |     |
| P00002 | 当 `EgressGatewayName` 为空时，创建集群级 `EgressPolicy` 时，会使用集群默认的 `EgressGateway`，检查 `EgressPolicySpec.EgressGatewayName` 及 `EgressPolicyStatus` 状态正确                                                                                 | p2  | false |     |     |
| P00003 | 当 `EgressGatewayName` 为空时，创建租户级 `EgressPolicy`时，如果对应租户注解上有相关 `EgressGateway` 的标注，则使用标注的 `EgressGatewa`，如果没有则使用集群默认的 `EgressGateway`，检查 `EgressPolicySpec.EgressGatewayName` 及 `EgressPolicyStatus` 状态正确                       | p2  | false |     |     |
| P00004 | 当 `EgressIP` 没有在 `Policy` 所选择的 `egressGateway` 的 `Ippools` 范围内，创建 EgressPolicy 会失败                                                                                                                                            | p2  | false |     |     |
| P00005 | 当 `AppliedTo` 为空时，创建 EgressPolicy 会失败                                                                                                                                                                                         | p2  | false |     |     |
| P00006 | 当同时设置 `AppliedTo.PodSubnet` 和 `AppliedTo.PodSelector` 时，创建 `Policy` 失败                                                                                                                                                        | p2  | false |     |     |
| P00007 | 当只设置了 `AppliedTo.PodSubnet`，与之匹配到的 `Pod` 的出口 IP 应是 `eip`，没有匹配到的 `Pod` 的出口 IP，应为非 `eip`，并且 `endpointSlice` 不会被创建                                                                                                               | p1  | true  |     |     |
| P00008 | 当 `EgressIP` 为空并且设置了 `AppliedTo.PodSelector` 时，`Policy` 的 `EgressPolicyStatus.Eip` 和 Pod 的出口 IP 为 `egressGateway` 的 `defaultEIP`，`policy` 的 `allocatorPolicy` 为 `default`、`useNodeIP` 为 `false`， `EgressGatewayStatus` 会如预期更新                                                                 | p1  | true  |     |     |
| P00009 | 当 `EgressIP` 的 IP 为空，并且 `EgressIP.AllocatorPolicy` 为轮询模式时， `eip` 会从 `EgressGatewaySpec.Ippools` 的 IP 中获取，检查 `EgressPolicyStatus` 和 `EgressGatewayStatus` 状态正确                                                                 | p2  | false |     |     |
| P00010 | 当 `EgressIP` 的 IP 不为空，并且 `EgressIP.AllocatorPolicy` 为轮询模式时， `EgressIP` 会生效， 检查 `EgressPolicyStatus` 和 `EgressGatewayStatus` 状态正确                                                                                              | p2  | false |     |     |
| P00011 | 当 `Policy` 的 `DestSubnet` 为空并且访问的目的 IP 不在 `egressClusterInfo.Status` 中的 IP 列表范围之内时，<br/>Pod 的出口 IP 为 `eip`                                                                                                                    | p1  | true  |     |     |
| P00012 | 当 `Policy` 的 `DestSubnet` 为空并且访问的目的 IP 在 `egressClusterInfo.Status` 中的 IP 列表范围之内时，<br/>Pod 的出口 IP 不为 `eip`                                                                                                                    | p1  | true  |     |     |
| P00013 | 设置 `DestSubnet` 和 `PodSelector`, 当访问与 `DestSubnet` 匹配的外部 IP 时，Pod 的出口 IP 为 `eip`,<br/>当访问与 `DestSubnet` 不匹配的外部 IP 时， Pod 的出口 IP 为非 `eip`                                                                                      | p1  | true  |     |     |
| P00014 | 编辑原本匹配 `DaemonSet-A` 的 `PodSelector` ，使之改为匹配 `DaemonSet-B`,<br/> `EgressEndpoint` 会由 `DaemonSet-A` 更新为 `DaemonSet-B` 的信息，<br/>并且 `DaemonSet-A` 所有 Pod 的 出口 IP 由 `eip` 改为非 `eip`，`DaemonSet-B` 所有 Pod 的出口 IP 由非 `eip` 改为 `eip` | p1  | true  |     |     |
| P00015 | 当 `EgressIP.UseNodeIP` 为 `true` 并且 `EgressIP` 的 IP 为空时，创建 `EgressPolicy`，<br/>`EgressPolicyStatus.Eip` 和 `EgressGatewayStatus.Eips` 的 IP 应该为空，并且 Pod 的出口 IP 为 egressGateway `nodeSelector` 所匹配的 node 的 IP                     | p1  | true  |     |     |
| P00016 | 当 `EgressIP.UseNodeIP` 为 `true` 并且 `EgressIP` 的 IP 不为空时，创建 `EgressPolicy` 会失败                                                                                                                                                 | p2  | false |     |     |
| P00017 | 当编辑 Policy 的 `EgressIP` 的 IP 时，会报错                                                                                                                                                                                            | p2  | false |     |     |
| P00018 | 当编辑 Policy 的 `EgressGatewayName` 时，会报错                                                                                                                                                                                        | p2  | false |     |     |
| P00019 | 当删除 Policy，`EgressGatewayStatus` 和 `EgressEndpoint` 将如预期更新，并且 Pod 的出口 IP 由 `eip` 改为非 `eip`                                                                                                                                    | p1  | true  |     |     |
| P00020 | `namespace-level` 的 Policy 只生效在它所指定的命名空间                                                                                                                                                                                      | p2  | false |     |     |