name: Call Release Charts

env:
  PR_LABEL: pr/robot_update
  PR_REVIWER: weizhoublue
  MERGE_BRANCH: github_pages
  CHART_OUTPUT_PATH: output/chart/*

on:
  workflow_call:
    inputs:
      ref:
        required: true
        type: string
      submit:
        required: true
        type: string
    outputs:
      artifact:
        description: "name of chart artifact"
        value: chart_package_artifact
        # value: ${{ jobs.example_job.outputs.output1 }}
  workflow_dispatch:
    inputs:
      ref:
        description: 'tag, sha, branch'
        required: true
        default: v1.0.0

permissions: write-all

jobs:
  get_ref:
    runs-on: ubuntu-latest
    outputs:
      ref: ${{ env.RUN_REF }}
      submit: ${{ env.RUN_SUBMIT }}
    steps:
      - name: Get Original Ref
        id: get_original_ref
        run: |
          if ${{ inputs.ref != '' }} ; then
              echo "call by workflow_call"
              ver=${{ inputs.ref }}
              echo "RUN_REF=${ver}" >> $GITHUB_ENV
              echo "RUN_SUBMIT=${{ inputs.submit }}" >> $GITHUB_ENV
          elif ${{ github.event_name == 'workflow_dispatch' }} ; then
              echo "call by self workflow_dispatch"
              ver=${{ github.event.inputs.ref }}
              echo "RUN_REF=${ver}" >> $GITHUB_ENV
              echo "RUN_SUBMIT=true" >> $GITHUB_ENV
          else
              echo "unexpected event: ${{ github.event_name }}"
              exit 1
          fi

  # packages tgz from /charts of original branch, deploy to /charts of target branch
  package_chart:
    runs-on: ubuntu-latest
    needs: get_ref
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          ref: ${{ needs.get_ref.outputs.ref }}

      - name: Install Helm
        uses: azure/setup-helm@v3.3

      - name: Package Chart
        continue-on-error: false
        run: |
          make chart_package

      - name: Upload Artifact
        uses: actions/upload-artifact@v3.1.0
        with:
          name: chart_package_artifact
          path: ${{ env.CHART_OUTPUT_PATH }}
          retention-days: 1
          if-no-files-found: error

  # update /index.yaml in the target branch
  update_githubpage:
    runs-on: ubuntu-latest
    needs: [package_chart, get_ref]
    if: ${{ needs.get_ref.outputs.submit == 'true' }}
    steps:
      - name: Get Base Chart URL
        id: get_base_url
        run: |
          name=${{ github.repository }}
          proj=${name#*/}
          url=https://${{ github.repository_owner }}.github.io/${proj}
          echo "RUN_URL=${url}" >> $GITHUB_ENV

      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          ref: ${{ env.MERGE_BRANCH }}
          persist-credentials: "true"

      - name: Download Artifact
        uses: actions/download-artifact@v3
        with:
          name: chart_package_artifact
          path: docs/charts/

      - name: Update Chart Yaml
        run: |
          cd docs
          helm repo index  ./charts  --url ${{ env.RUN_URL }}/charts
          mv ./charts/index.yaml ./index.yaml

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v4.2.0
        with:
          title: "robot Update chart from ${{ needs.get_ref.outputs.ref }} to branch ${{ env.MERGE_BRANCH }} "
          commit-message: "robot Update chart from ${{ needs.get_ref.outputs.ref }} to branch ${{ env.MERGE_BRANCH }} "
          branch-suffix: timestamp
          branch: robot/update_chart
          delete-branch: true
          base: ${{ env.MERGE_BRANCH }}
          signoff: true
          token: ${{ secrets.WELAN_PAT }}
          labels: ${{ env.PR_LABEL }}
          reviewers: ${{ env.PR_REVIWER }}
